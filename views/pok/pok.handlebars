<div class="animated fadeIn">
    <div class="card" id="new">
        <div class="card-header"><i class="icon-calculator"></i> Pengelolaan Petunjuk Operasional Kegiatan (POK)</div>
            <div class="card-block">
                <div class="row">
                    <div class="col-md-12">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a id="pok_summary_tab" class="nav-link active" data-toggle="tab" href="#summarychild" role="tab" aria-control="entrychild"><i class="icon-speedometer"></i> Summary</a>
                            </li>
                            <li class="nav-item">
                                <a id="pok_entry_tab" class="nav-link" data-toggle="tab" href="#entrychild" role="tab" aria-control="entrychild"><i class="icon-eye"></i> Entri</a>
                            </li>
                            {{#if admin}}
                            <li class="nav-item">
                                <a id="pok_edit_tab" class="nav-link" data-toggle="tab" href="#utamachild" role="tab" aria-control="utamachild"><i class="icon-note"></i> Edit</a>
                            </li>
                            <li class="nav-item">
                                <a id="pok_unggah_tab" class="nav-link" data-toggle="tab" href="#unggahTabchild" role="tab" aria-controls="unggahTabchild"><i class="icon-link"></i> Unggah</a>
                            </li>
                            {{/if}}
                        </ul> 
                        <div class="tab-content">
                            <div class="tab-pane active" id="summarychild" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-12" style="padding-left: 0">
                                        <p>Selamat Datang, {{username}}!</p>
                                    </div>
                                </div>
                                <!-- <div class="row">
                                    <div class="col-md-12">
                                        <h6 class="text-center pok-title" style="margin-bottom: 10px">
                                            Realisasi Anggaran {{tahun_anggaran}}
                                        </h6>
                                    </div>
                                </div> -->
                                <div class="row">
                                    <div class="col-md-4">
                                        <div id="container" style="width: 100%; height: 420px; margin: 0 auto"></div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="top_mines" style="width: 100%; height: 420px; margin: 0 auto"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="entrychild" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-12">
                                        <h6 class="text-center pok-title" style="margin-bottom: 10px">
                                            {{pok_name}}
                                        </h6>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6 col-lg-3" style="padding-left: 0">
                                        <div class="card">
                                            <div class="card-block p-0 clearfix">
                                                <i class="fa fa-calendar-o bg-primary p-2 font-2xl mr-1 float-left"></i>
                                                <div class="h6 text-primary mb-0 pt-1">Rp <span id="realisasi-bulan-ini">0</span><span id="realisasi-bulan-ini-percent" style="font-size: 0.7rem"> (0%)</span></div>
                                                <div class="text-muted text-uppercase font-weight-bold font-xs">Bulan Ini</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/.col-->
                                    <div class="col-6 col-lg-3" style="padding-left: 0">
                                        <div class="card">
                                            <div class="card-block p-0 clearfix">
                                                <i class="fa fa-calendar-check-o bg-primary p-2 font-2xl mr-1 float-left"></i>
                                                <div class="h6 text-primary mb-0 pt-1">Rp <span id="realisasi-bulan-lalu">0</span><span id="realisasi-bulan-lalu-percent" style="font-size: 0.7rem"> (0%)</span></div>
                                                <div class="text-muted text-uppercase font-weight-bold font-xs">Sampai Bulan Lalu</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/.col-->
                                    <div class="col-6 col-lg-3" style="padding-left: 0">
                                        <div class="card">
                                            <div class="card-block p-0 clearfix">
                                                <i class="fa fa-calendar bg-primary p-2 font-2xl mr-1 float-left"></i>
                                                <div class="h6 text-primary mb-0 pt-1">Rp <span id="sampai-bln-ini">0</span><span id="sampai-bln-ini-percent" style="font-size: 0.7rem"> (0%)</span></div>
                                                <div class="text-muted text-uppercase font-weight-bold font-xs">Sampai Bulan Ini</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/.col-->
                                    <div class="col-6 col-lg-3" style="padding-left: 0">
                                        <div class="card">
                                            <div class="card-block p-0 clearfix">
                                                <i class="fa fa-bell-o bg-primary p-2 font-2xl mr-1 float-left"></i>
                                                <div class="h6 text-primary mb-0 pt-1">Rp <span id="sisa-dana">0</span><span id="sisa-dana-percent" style="font-size: 0.7rem"> (0%)</span></div>
                                                <div class="text-muted text-uppercase font-weight-bold font-xs">Sisa Dana</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/.col-->
                                </div>
                                <div class="row">
                                    <div class="col-md-12" style="padding-left: 0;">
                                        <p>
                                            Download sebagai: <a id="download_pdf" href="pok/download/pdf"><i class="fa fa-file-pdf-o fa-sm mt-2"></i> Pdf </a> | <a id="download_xlsx" href="pok/download/xlsx"><i class="fa fa-file-excel-o fa-sm mt-2"></i> Xlsx</a>
                                        </p>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <div class="form-group row">
                                            <label for="jenis_item" class="col-md-2 form-control-label no-left-padding">Bulan:</label>
                                            <div class="col-md-9">
                                                <select class="col-md-9 form-control" id="bulan_realisasi" name="bulan_realisasi" size="1">
                                                    <option value="none">--pilih--</option>
                                                    <option value="0">Januari</option>
                                                    <option value="1">Februari</option>
                                                    <option value="2">Maret</option>
                                                    <option value="3">April</option>
                                                    <option value="4">Mei</option>
                                                    <option value="5">Juni</option>
                                                    <option value="6">Juli</option>
                                                    <option value="7">Agustus</option>
                                                    <option value="8">September</option>
                                                    <option value="9">Oktober</option>
                                                    <option value="10">November</option>
                                                    <option value="11">Desember</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="main_section" class="row">
                                    <div class="col-md-12" style="padding-left: 0;">                                    
                                    <table id="pok_table_entry" class="table table-bordered" width="100%">
                                        <thead>
                                            <tr>
                                                <th rowspan="2">Id</th>
                                                <th rowspan="2">Parent_id</th>
                                                <th rowspan="2" class="tipe">Tipe</th>
                                                <th class="default-sort-column-entry" rowspan="2">Kode</th>
                                                <th rowspan="2" class="uraian">Uraian</th>
                                                <th rowspan="2">Volume</th>
                                                <th rowspan="2">Satuan</th>
                                                <th rowspan="2">Harga Satuan</th>
                                                <th rowspan="2">Jumlah</th>
                                                <th rowspan="2">Pengeluaran</th>
                                                <th rowspan="2">Realisasi Bulan Lalu</th>
                                                <th colspan="2">Realisasi s/d Bulan ini</th>
                                                <th rowspan="2">Sisa Dana</th>
                                                <th rowspan="2" class="pilihan">Pilihan</th>
                                            </tr>
                                            <tr>
                                                <th>Rp</th>
                                                <th>%</th>                                                
                                            </tr>
                                        </thead>
                                        <tbody>                
                                        </tbody>
                                    </table>
                                    </div>
                                </div>
                            </div>
                            {{#if admin}}
                            <div class="tab-pane" id="utamachild" role="tabpanel">
                                <div class="form-group row">
                                    <div class="col-md-3" style="border-right: 1px solid #ccc;">
                                        <div class="form-group row">
                                            <label for="jenis_item" class="col-md-3 form-control-label no-left-padding">Tambah:</label>
                                            <div class="col-md-9">
                                                <select class="col-md-9 form-control" id="jenis_item" name="jenis_item" size="1">
                                                    <option value="none" selected="selected">--pilih--</option>
                                                    <option value="program">Program</option>
                                                    <option value="kegiatan">Kegiatan</option>
                                                    <option value="output">Output</option>
                                                    <option value="soutput">Sub Output</option>
                                                    <option value="komponen">Komponen</option>
                                                    <option value="skomponen">Sub Komponen</option>
                                                    <option value="akun">Akun</option>
                                                    <option value="detail">Detail Belanja</option>
                                                </select>
                                            </div>
                                        </div>
                                        <form id="tambah_item_pok" method="post" action="/pok/tambah_item_pok">
                                            
                                        </form>
                                    </div>
                                    <div class="col-md-9">
                                        <p>Edit Daftar Uraian Akun:</p>
                                        <button id="btn-edit-uraian-akun" type="button">Buka dialog</button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <h6 class="text-center" style="margin-bottom: 30px">
                                            <span class="pok-title">{{pok_name}}&nbsp;</span><i class="fa fa-pencil fa-sm mt-2 edit"></i><input id="pok_title" type="text" value="{{pok_name}}"/>
                                        </h6>
                                    </div>
                                </div>
                                <div id="main_section" class="row">
                                    <div class="col-md-12" style="padding-left: 0;">                                    
                                        <table id="pok_table_edit" class="table table-bordered" width="100%">
                                            <thead>
                                                <tr>
                                                    <th>Id</th>
                                                    <th>Parent_id</th>
                                                    <th class="tipe">Tipe</th>
                                                    <th class="default-sort-column">Kode</th>
                                                    <th class="uraian">Uraian</th>
                                                    <th>Volume</th>
                                                    <th>Satuan</th>
                                                    <th>Harga Satuan</th>
                                                    <th>Jumlah</th>
                                                    <th class="pilihan">Pilihan</th>
                                                </tr>
                                            </thead>
                                            <tbody>                
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="unggahTabchild" role="tabpanel">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <form id="form_pok_unggah" enctype="multipart/form-data" method="post" action="/pok/unggah_pok">
                                            <div class="form-group row">
                                                <label for="nomor">Nama</label>
                                                <input type="text" id="pok_name" name="pok_name" class="form-control" placeholder="nama..." value="{{#if pok_name}}{{pok_name}}{{/if}}{{#unless pok_name}}POK Revisi 1{{/unless}}" required>
                                            </div> 
                                            <div class="form-group row">
                                                <label for="nomor">Tahun Anggaran</label>
                                                <input type="text" id="thang" name="thang" class="form-control" placeholder="thn anggaran..." value="{{tahun_anggaran}}" required>
                                            </div> 
                                            <div class="form-group row">
                                                <label for="nomor">File</label>
                                                <input name="pok_file" type="file" class="form-control" required accept=".xlsx,.xls"/>
                                            </div> 
                                            <div class="row">
                                                <button id="pok_unggah_button" type="submit">Unggah</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <h6 class="text-center" style="margin-bottom: 30px">
                                            <span>Perubahan POK</span>
                                        </h6>
                                    </div>
                                </div>
                                <div id="main_section" class="row">
                                    <div class="col-md-12" style="padding-left: 0;">                                    
                                        <table id="pok_table_change" class="table table-bordered" width="100%">
                                            <thead>
                                                <tr>
                                                    <th>Id</th>
                                                    <th>Status</th>
                                                    <th>Asal</th>
                                                    <th>Uraian</th>
                                                    <th>Volume</th>
                                                    <th>Satuan</th>
                                                    <th>Harga Satuan</th>
                                                    <th>Jumlah</th>
                                                    <th>Pilihan</th>
                                                </tr>
                                            </thead>
                                            <tbody>             
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            {{/if}}
                        </div> 
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--/.row-->
</div>

<div class="modal fade" id="entry_modal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div id="modal-remove-lg" style="max-width: 500px;" class="modal-dialog modal-primary" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Entri Pengeluaran <span class="detail_blnj_entry"></span></h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="entri_form" method="post" action="/pok/entry_pengeluaran">
                <div class="modal-body" style="padding: 0 15px;">
                    <div style="padding: 15px; padding-bottom: 0">
                        <div class="form-group row">
                            <div class="col-md-12">
                                <label class="radio-inline" for="satu_penerima_radio">
                                    <input id="satu_penerima_radio" type="radio" name="entri_banyak_penerima" value="0" checked="checked">Satu penerima
                                </label>
                                <label class="radio-inline" for="banyak_penerima_radio" style="margin-left: 10px">
                                    <input type="radio" id="banyak_penerima_radio" name="entri_banyak_penerima" value="1">Banyak penerima
                                </label>
                                <label class="radio-inline" for="import_radio" style="margin-left: 10px">
                                    <input type="radio" id="import_radio" name="entri_banyak_penerima" value="2">Import Data
                                </label>
                            </div>
                        </div>
                        <div id="fields_form_entry">
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">Jumlah<span> *</span></label>
                                <div class="col-md-4">
                                    <input id="entry_jumlah_field" type="text" class="form-control format-uang" autocomplete="off" required>
                                </div>
                            </div> 
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">Penerima<span> *</span></label>
                                <div class="col-md-9">
                                    <input id="entry_penerima_name_field" type="text" class="form-control penerima-autocomplete" autocomplete="off" required>
                                    <input id="entry_penerima_id_field" style="display: none;" type="text">
                                </div>
                            </div> 
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">Tanggal<span> *</span></label>
                                <div class="col-md-5">
                                    <input id="entry_tgl_field" type="text" class="form-control" autocomplete="off" required>
                                    <input id="entry_tgl_ts_field" style="display: none;" type="text" class="form-control">
                                </div>
                            </div> 
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">PPh 21</label>
                                <div class="col-md-4">
                                    <input id="pph21" type="text" class="form-control format-uang" autocomplete="off">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">PPh 22</label>
                                <div class="col-md-4">
                                    <input id="pph22" type="text" class="form-control format-uang" autocomplete="off">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">PPh 23</label>
                                <div class="col-md-4">
                                    <input id="pph23" type="text" class="form-control format-uang" autocomplete="off">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">PPn</label>
                                <div class="col-md-4">
                                    <input id="ppn" type="text" class="form-control format-uang" autocomplete="off">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">No. SPM</label>
                                <div class="col-md-4">
                                    <input id="entry_spmno_field" type="text" class="form-control" autocomplete="off">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">No. Bukti</label>
                                <div class="col-md-4">
                                    <input id="entry_buktino_field" type="text" class="form-control" autocomplete="off">
                                </div>
                            </div> 
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">Keterangan</label>
                                <div class="col-md-9">
                                    <textarea id="entry_ket_field" rows="3" class="form-control"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Kembali</button>
                    <button id="entri_submit" type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="riwayat_modal" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
    <div class="modal-dialog modal-primary modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Riwayat realisasi <span class="detail_blnj_riwayat"></span></h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 0 15px;">
                <div style="padding: 15px; padding-bottom: 0">
                    <div style="height: 510px;position:relative;">
                        <div style="max-height:100%;overflow-y:auto;overflow-x:hidden;">
                            <div class="row">
                                <div class="col-md-6" style="border-right: 1px solid #ccc; margin-bottom: 5px">
                                    <div class="row" style="margin-bottom: 5px">
                                        <div class="col-md-12">
                                            <strong>Berdasarkan item :</strong>
                                        </div>
                                    </div>
                                    <form id="riwayat_form" method="post" action="/pok/riwayat_pengeluaran">
                                        <div class="form-group row">
                                            <label class="col-md-3 form-control-label" for="tbh_program">Program</label>
                                            <div class="col-md-9">
                                                <select id="tbh_entry_program" name="tbh_entry_program" class="form-control pok-entry-dropdown" size="1"></select>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-md-3 form-control-label" for="tbh_kegiatan">Kegiatan</label>
                                            <div class="col-md-9">
                                                <select id="tbh_entry_kegiatan" name="tbh_entry_kegiatan" class="form-control pok-entry-dropdown" size="1"></select>
                                            </div>
                                        </div> 
                                        <div class="form-group row">
                                            <label class="col-md-3 form-control-label" for="tbh_output">Output</label>
                                            <div class="col-md-9">
                                                <select id="tbh_entry_output" name="tbh_entry_output" class="form-control pok-entry-dropdown" size="1"></select>
                                            </div>
                                        </div> 
                                        <div class="form-group row">
                                            <label class="col-md-3 form-control-label" for="tbh_s_output">Sub Output</label>
                                            <div class="col-md-9">
                                                <select id="tbh_entry_soutput" name="tbh_entry_s_output" class="form-control pok-entry-dropdown" size="1"></select>
                                            </div>
                                        </div> 
                                        <div class="form-group row">
                                            <label class="col-md-3 form-control-label" for="tbh_komponen">Komponen</label>
                                            <div class="col-md-9">
                                                <select id="tbh_entry_komponen" name="tbh_entry_komponen" class="form-control pok-entry-dropdown" size="1"></select>
                                            </div>
                                        </div> 
                                        <div class="form-group row">
                                            <label class="col-md-3 form-control-label" for="tbh_s_komponen">Sub Komponen</label>
                                            <div class="col-md-9">
                                                <select id="tbh_entry_skomponen" name="tbh_entry_s_komponen" class="form-control pok-entry-dropdown" size="1"></select>
                                            </div>
                                        </div> 
                                        <div class="form-group row">
                                            <label class="col-md-3 form-control-label" for="tbh_akun">Akun</label>
                                            <div class="col-md-9">
                                                <select id="tbh_entry_akun" name="tbh_entry_akun" class="form-control pok-entry-dropdown" size="1"></select>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-md-3 form-control-label" for="tbh_d_blnj">Detail Belanja</label>
                                            <div class="col-md-9">
                                                <select id="tbh_entry_detail" name="tbh_entry_d_blnj" class="form-control" size="1"></select>
                                            </div>
                                        </div>
                                    </form>
                                </div>                                
                                <div class="col-md-6">
                                    <div class="row" style="margin-bottom: 5px">
                                        <div class="col-md-12">
                                            <strong>Berdasarkan waktu :</strong>
                                        </div>
                                    </div>
                                    <form id="riwayat_form" method="post" action="/pok/riwayat_pengeluaran">
                                        <div class="form-group row">
                                            <div class="col-md-12">
                                                <div class="radio">
                                                    <label for="tampil-riwayat-by-range">
                                                        <input type="radio" id="tampil-riwayat-by-range" name="tampil_riwayat" value="0"> Periode <input id="riwayat-lower_ts" type="text"> - <input id="riwayat-upper_ts" type="text">
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <div class="col-md-12">
                                                <div class="radio">
                                                    <label for="tampil-riwayat-by-month">
                                                        <input type="radio" id="tampil-riwayat-by-month" name="tampil_riwayat" value="1" checked="checked"> Bulan 
                                                        <select id="bulan_realisasi_modal" name="bulan_realisasi_modal" size="1">
                                                            <option value="none">--pilih--</option>
                                                            <option value="0">Januari</option>
                                                            <option value="1">Februari</option>
                                                            <option value="2">Maret</option>
                                                            <option value="3">April</option>
                                                            <option value="4">Mei</option>
                                                            <option value="5">Juni</option>
                                                            <option value="6">Juli</option>
                                                            <option value="7">Agustus</option>
                                                            <option value="8">September</option>
                                                            <option value="9">Oktober</option>
                                                            <option value="10">November</option>
                                                            <option value="11">Desember</option>
                                                        </select>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <p>
                                        Download sebagai: <a id="download_pdf2" href="#"><i class="fa fa-file-pdf-o fa-sm mt-2"></i> Pdf </a> | <a id="download_xlsx2" href="#"><i class="fa fa-file-excel-o fa-sm mt-2"></i> Xlsx</a>
                                    </p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <table id="tbl_riwayat" class="table" cellspacing="0" width="100%">
                                        <thead>
                                            <tr>
                                                <th>_id</th>
                                                <th><input type="checkbox" name="select_all" value="1" id="example-select-all"></th>
                                                <th class="default-sort-column">No.</th>
                                                <th>Tanggal</th>
                                                <th>Penerima</th>
                                                <th>Jumlah</th>
                                                <th>PPh 21</th>
                                                <th>PPh 22</th>
                                                <th>PPh 23</th>
                                                <th>PPn</th>
                                                <th>Nmr SPM</th>
                                                <th>Nmr Bukti</th>
                                                <th>Ket</th>
                                                <th>Pengentri</th>
                                                <th>Pilihan</th>
                                            </tr>
                                        </thead>
                                        <tfoot>
                                          <tr>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th class="format-uang"></th>
                                            <th class="format-uang"></th>
                                            <th class="format-uang"></th>
                                            <th class="format-uang"></th>
                                            <th class="format-uang"></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                          </tr>
                                        </tfoot>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12" id="multiple-action" style="margin: 0 auto; text-align: center; margin-bottom: 10px">
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Kembali</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="edit-uraian-akun" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
    <div class="modal-dialog modal-primary" role="document" style="max-width: 500px;">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Edit Daftar Uraian Akun</h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 0 15px;">
                <div style="padding: 15px; padding-bottom: 0">
                    <div class="row">
                        <div class="col-md-10">
                            <strong>Tambah uraian :</strong>
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">Kode</label>
                                <div class="col-md-9">
                                    <input id="eua_kode_akun" type="text" class="form-control">
                                </div>
                            </div> 
                            <div class="form-group row">
                                <label class="col-md-3 form-control-label">Uraian</label>
                                <div class="col-md-9">
                                    <input id="eua_uraian_akun" type="text" class="form-control">
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-12">
                                    <button id="btn-tambah-uraian-akun" type="button">Tambah</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <table id="tbl_eua" class="table table-bordered" style="table-layout:fixed;width: 100%;">
                                <thead>
                                    <tr>
                                        <th width="20%">Kode</th>
                                        <th width="60%">Uraian</th>
                                        <th width="20%">Pilihan</th>
                                    </tr>
                                </thead>
                                <tbody>                       
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Kembali</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="pok_unduh_rename" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div id="modal-remove-lg" class="modal-dialog modal-primary" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Tambahkan Uraian</h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
                <div class="modal-body" style="padding: 0 15px;">
                    <div style="padding: 15px; padding-bottom: 0">
                        <div style="height: 480px;position:relative;">
                            <div style="max-height:100%;overflow-y:auto;overflow-x:hidden;">
                                <div class="row">
                                    <div class="col-md-12">
                                        <strong>Program :</strong>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div style="height: 100px;position:relative;">
                                            <div style="max-height:100%;overflow-y:auto;overflow-x:hidden;">
                                                <div id="prog_ht">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <strong>Kegiatan :</strong>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div style="height: 100px;position:relative;">
                                            <div style="max-height:100%;overflow-y:auto;overflow-x:hidden;">
                                                <div id="keg_ht">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <strong>Akun :</strong>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div style="height: 250px;position:relative;">
                                            <div style="max-height:100%;overflow-y:auto;overflow-x:hidden;">
                                                <div id="akun_ht">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Kembali</button>
                    <button id="btn-simpan-uraian" type="button" class="btn btn-primary">Simpan</button>
                </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="link_realisasi_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Transfer Realisasi</h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="padding: 15px">
                    <div class="col-md-12" style="padding: 0">
                        <div class="form-group row">
                            <label class="col-md-3 form-control-label" for="tbh_program">Program</label>
                            <div class="col-md-9">
                                <select id="link_entry_program" name="tbh_entry_program" class="form-control pok-link-dropdown" size="1"></select>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-md-3 form-control-label" for="tbh_kegiatan">Kegiatan</label>
                            <div class="col-md-9">
                                <select id="link_entry_kegiatan" name="tbh_entry_kegiatan" class="form-control pok-link-dropdown" size="1"></select>
                            </div>
                        </div> 
                        <div class="form-group row">
                            <label class="col-md-3 form-control-label" for="tbh_output">Output</label>
                            <div class="col-md-9">
                                <select id="link_entry_output" name="tbh_entry_output" class="form-control pok-link-dropdown" size="1"></select>
                            </div>
                        </div> 
                        <div class="form-group row">
                            <label class="col-md-3 form-control-label" for="tbh_s_output">Sub Output</label>
                            <div class="col-md-9">
                                <select id="link_entry_soutput" name="tbh_entry_s_output" class="form-control pok-link-dropdown" size="1"></select>
                            </div>
                        </div> 
                        <div class="form-group row">
                            <label class="col-md-3 form-control-label" for="tbh_komponen">Komponen</label>
                            <div class="col-md-9">
                                <select id="link_entry_komponen" name="tbh_entry_komponen" class="form-control pok-link-dropdown" size="1"></select>
                            </div>
                        </div> 
                        <div class="form-group row">
                            <label class="col-md-3 form-control-label" for="tbh_s_komponen">Sub Komponen</label>
                            <div class="col-md-9">
                                <select id="link_entry_skomponen" name="tbh_entry_s_komponen" class="form-control pok-link-dropdown" size="1"></select>
                            </div>
                        </div> 
                        <div class="form-group row">
                            <label class="col-md-3 form-control-label" for="tbh_akun">Akun</label>
                            <div class="col-md-9">
                                <select id="link_entry_akun" name="tbh_entry_akun" class="form-control pok-link-dropdown" size="1"></select>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-md-3 form-control-label" for="tbh_d_blnj">Detail Belanja</label>
                            <div class="col-md-9">
                                <select id="link_entry_detail" name="tbh_entry_d_blnj" class="form-control" size="1"></select>
                            </div>
                        </div>
                    </div>  
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button id="btn-ubah-detail-submit" type="button" class="btn btn-primary">Simpan</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="lihat-akun-modal" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
    <div class="modal-dialog modal-primary" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Akun: <span id="lihat-akun-modal-title"></span></h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 0 15px;">
                <div style="padding: 15px; padding-bottom: 0">
                    <div style="height: 510px;position:relative;">
                        <div style="max-height:100%;overflow-y:auto;overflow-x:hidden;">
                            <div class="row">
                                <div class="col-md-12">
                                    <table id="tbl-lihat-akun" class="table" cellspacing="0" width="100%">
                                        <thead>
                                            <tr>
                                                <th>Id</th>
                                                <th>Status</th>
                                                <th>Uraian</th>
                                                <th>Volume</th>
                                                <th>Satuan</th>
                                                <th>Harga Satuan</th>
                                                <th>Jumlah</th>
                                                <th>Pilihan</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Kembali</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal-timpa-detail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Akun: <span id="timpa-lihat-akun-modal-title"></span></h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="padding: 15px">
                    <p>Timpa detail ke (realisasi tidak dihapus):</p>
                    <div class="col-md-12" style="padding: 0">
                        <div class="form-group row">
                            <div class="col-md-12">
                                <select id="timpa_d_blnj_list" name="timpa_d_blnj_list" class="form-control" size="1"></select>
                            </div>
                        </div>
                    </div>  
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button id="btn-timpa" type="button" class="btn btn-primary">Timpa</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<script src="/js/handsontable.full.min.js"></script>

<script src="/js/moment.min.js"></script>
<script src="/js/locale/id.js"></script>
<script src="/js/bootstrap-datetimepicker.js"></script>

<script src="/js/highcharts.js"></script>
<script src="/js/data.js"></script>
<script src="/js/drilldown.js"></script>
<script src="/js/exporting.js"></script>
<script src="/js/offline-exporting.js"></script>

<script type="text/javascript">
    socket = io.connect($(location).attr('host'));

    //untuk hak akses
    var user_aktiv = '{{username}}';

    $('#pok_menu').attr('class', 'nav-link active');


    $('head').append( $('<link rel="stylesheet" type="text/css"/>').attr('href', "/css/handsontable.full.min.css"));
    /////////// UMUM ////////////
    //plug in
    //reset sorting table
    $(document).ready(function(){
        jQuery.fn.dataTableExt.oApi.fnSortNeutral = function ( oSettings )
        {
            /* Remove any current sorting */
            oSettings.aaSorting = [];

            /* Sort display arrays so we get them in numerical order */
            oSettings.aiDisplay.sort( function (x,y) {
                return x-y;
            } );
            oSettings.aiDisplayMaster.sort( function (x,y) {
                return x-y;
            } );

            /* Redraw */
            oSettings.oApi._fnReDraw( oSettings );
        };

        //format uang
        $('td.format-uang').autoNumeric('init', {digitGroupSeparator: ',', decimalCharacter: '.', decimalPlacesOverride: '0'});

        ///////// init ///////////
        //table
        var tabel_pok_edit = $('#pok_table_edit');
        var tabel_pok_entry = $('#pok_table_entry');
        var tabel_riwayat = $('#tbl_riwayat');
        var tabel_pok_entry_daftar_penerima = $('#tbl_tambah_penerima');
        //form pok
        var form_tbh_pok = $('#tambah_item_pok');
        var form_entri_pok = $('#entri_form');
        var form_pok_unggah = $('#form_pok_unggah');
        //modal
        var entry_modal = $('#entry_modal');
        var riwayat_modal = $('#riwayat_modal');

        ////////// ENTRY
        //search & sort
        //tabel pok entry
        tabel_pok_entry.DataTable({
            scrollY:        false,//'500px',
            scrollX:        true,
            scrollCollapse: true,
            fixedColumns:   {
                leftColumns: 5,
                rightColumns: 1
            },
            columnDefs: [
                {
                    "targets": [ 0, 1 ],
                    "visible": false,
                    "searchable": false
                }
            ],
            aaSorting: [],
            rowReorder: {
                enable: false
            },
            paging: false,
            createdRow: function( row, data, dataIndex ) {
                if(/^054/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level0');
                } else if(/^\d{4}$/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level1');
                } else if(/^\d{4}\./.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level2');
                } else if(/^\d{3}\.\d{3}$/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level3');
                } else if(/^\d{3}$/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level4');
                } else if(/[A-Z]/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level5');
                } else if(/^\d{6}/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level6');
                } else {
                    $( row ).find('td:eq(1)').attr('class', 'level6');
                }
                $( row ).find('td:eq(3)').attr('class','format-uang');
                $( row ).find('td:eq(4)').attr('class', 'satuan-unit');
                $( row ).find('td:eq(5)').attr('class', 'format-uang');
                $( row ).find('td:eq(6)').attr('class', 'format-uang');
                $( row ).find('td:eq(7)').attr('class', 'format-uang');
                $( row ).find('td:eq(8)').attr('class', 'format-uang');
                $( row ).find('td:eq(9)').attr('class', 'format-uang');
                $( row ).find('td:eq(10)').attr('class', 'format-uang');
                $( row ).find('td:eq(11)').attr('class', 'format-uang');
            }
        });

        tabel_riwayat.DataTable({
            columnDefs: [
                {
                    "targets": [ 0 ],
                    "visible": false,
                    "searchable": false
                },
                {
                   'targets': 1,
                   'searchable':false,
                   'orderable':false,
                   'className': 'dt-body-center',
                   'render': function (data, type, full, meta){
                       return '<input type="checkbox" name="id[]" value="' + $('<div/>').text(full[0]).html() + '">';
                   }
                }
            ],
            aaSorting: [],
            rowReorder: {
                enable: false
            },
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Semua"]],
            createdRow: function( row, data, dataIndex ) {
                if(!data[6]){
                    $( row ).find('td:eq(5)').text('-');
                }
                if(!data[7]){
                    $( row ).find('td:eq(6)').text('-');
                }
                if(!data[8]){
                    $( row ).find('td:eq(7)').text('-');
                }
                if(!data[9]){
                    $( row ).find('td:eq(8)').text('-');
                }
                if(!data[10]){
                    $( row ).find('td:eq(9)').text('-');
                }
                if(!data[11]){
                    $( row ).find('td:eq(10)').text('-');
                }
                if(!data[12]){
                    $( row ).find('td:eq(11)').text('-');
                }
                $( row ).find('td:eq(1)').attr('class', 'text-center').text(dataIndex+1);
                $( row ).find('td:eq(2)').attr('class', 'text-center');
                $( row ).find('td:eq(4)').attr('class', 'format-uang');
                $( row ).find('td:eq(5)').attr('class', 'format-uang');
                $( row ).find('td:eq(6)').attr('class', 'format-uang');
                $( row ).find('td:eq(7)').attr('class', 'format-uang');
                $( row ).find('td:eq(8)').attr('class', 'format-uang');
                $( row ).find('td:eq(4)').autoNumeric('init', {digitGroupSeparator: ',', decimalCharacter: '.', decimalPlacesOverride: '0'});
                setAutoNumeric( $( row ).find('td:eq(4)'), data[5]);
                $( row ).find('td:eq(5)').autoNumeric('init', {digitGroupSeparator: ',', decimalCharacter: '.', decimalPlacesOverride: '0'});
                $( row ).find('td:eq(6)').autoNumeric('init', {digitGroupSeparator: ',', decimalCharacter: '.', decimalPlacesOverride: '0'});
                $( row ).find('td:eq(7)').autoNumeric('init', {digitGroupSeparator: ',', decimalCharacter: '.', decimalPlacesOverride: '0'});
                $( row ).find('td:eq(8)').autoNumeric('init', {digitGroupSeparator: ',', decimalCharacter: '.', decimalPlacesOverride: '0'});
                $( row ).find('td:eq(9)').attr('class', 'text-center');
                $( row ).find('td:eq(10)').attr('class', 'text-center');
                $( row ).find('td:eq(12)').attr('class', 'text-center');
                $( row ).find('td:eq(13)').attr('class', 'text-center');
            },
            "footerCallback": function ( row, data, start, end, display ) {
                var api = this.api(), data;
     
                // Remove the formatting to get integer data for summation
                var intVal = function ( i ) {
                    return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '')*1 :
                        typeof i === 'number' ?
                            i : 0;
                };
     
                // Total over all pages
                total4 = api
                    .column( 5 )
                    .data()
                    .reduce( function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0 );
                total5 = api
                    .column( 6 )
                    .data()
                    .reduce( function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0 );
                total6 = api
                    .column( 7 )
                    .data()
                    .reduce( function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0 );
                total7 = api
                    .column( 8 )
                    .data()
                    .reduce( function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0 );
                total8 = api
                    .column( 9 )
                    .data()
                    .reduce( function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0 );
     
                // Total over this page
                // pageTotal4 = api
                //     .column( 4, { page: 'current'} )
                //     .data()
                //     .reduce( function (a, b) {
                //         return intVal(a) + intVal(b);
                //     }, 0 );
     
                // Update footer
                $( api.column( 2 ).footer() ).html(
                    'Total'
                );
                $( api.column( 5 ).footer() ).html(
                    formatUang(total4)
                );
                $( api.column( 6 ).footer() ).html(
                    formatUang(total5)
                );
                $( api.column( 7 ).footer() ).html(
                    formatUang(total6)
                );
                $( api.column( 8 ).footer() ).html(
                    formatUang(total7)
                );
                $( api.column( 9 ).footer() ).html(
                    formatUang(total8)
                );
            }
        });

        $('#example-select-all').on('click', function(){

           if(this.checked){

                $('#multiple-action').html(

                    '<button id="btn-multiple-delete" type="button" style="height:35px;width:35px;" title="Hapus terpilih"><i class="icon-close font-lg"></i></button> '
                    +'<button id="btn-multiple-move" type="button" style="height:35px;width:35px;" title="Pindahkan terpilih ke rincian lain"><i class="icon-share-alt font-lg"></i></i></button>'

                )

           } else {
               $('#multiple-action').html('');
           }

           // Get all rows with search applied
           var rows = tabel_riwayat.DataTable().rows({ 'search': 'applied' }).nodes();
           // Check/uncheck checkboxes for all rows in the table
           $('input[type="checkbox"]', rows).prop('checked', this.checked);

           
        });

        //function
        $.fn.serializeObject = function()
        {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function() {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };

        $('#riwayat_modal tbody').on('change', 'input[type="checkbox"]', function(){
           // If checkbox is not checked
           if(!this.checked){
              var el = $('#example-select-all').get(0);
              // If "Select all" control is checked and has 'indeterminate' property
              if(el && el.checked && ('indeterminate' in el)){
                 // Set visual state of "Select all" control
                 // as 'indeterminate'
                 el.indeterminate = true;
              }
           }
           var checked = tabel_riwayat.DataTable().$('input[type="checkbox"]').serializeObject()['id[]'];

           if(this.checked){

                $('#multiple-action').html(

                    '<button id="btn-multiple-delete" type="button" style="height:35px;width:35px;"><i class="icon-close font-lg"></i></button> '
                    +'<button id="btn-multiple-move" type="button" style="height:35px;width:35px;"><i class="icon-share-alt font-lg"></i></i></button>'

                )

           } else if(!checked){
               $('#multiple-action').html('');
           }
        });

        $('#riwayat_modal').on('click', '#btn-multiple-delete', function(){
            if(!tabel_riwayat.DataTable().$('input[type="checkbox"]').serializeObject()['id[]']){
                generalAlert('Tidak ada realisasi yang terpilih.')
                return;
            }
            $("#btn-multiple-delete").html('<i class="fa fa-spinner fa-pulse fa-1x fa-fw font-lg"></i>');
            $("#btn-multiple-delete").prop("disabled",true);
            var checked = tabel_riwayat.DataTable().$('input[type="checkbox"]').serializeObject()['id[]'];
            if(typeof checked === 'string'){
                checked = [checked];
            }
            $('#example-select-all').prop('checked', false);
            _.each(checked, function(id, index, list){
                socket.emit('del_riwayat', {'parent_id': $("#tbh_entry_detail").val(), 'target_id': id, 
                'month': $('#bulan_realisasi').val()}, function(status){
                    var row_affected = tabel_riwayat.DataTable()
                                    .rows( function ( idx, data, node ) {
                                        return data[0] == id ?
                                            true : false;
                                    } )
                                    .nodes()
                                    .to$();
                    tabel_riwayat.DataTable().row(row_affected).remove().draw(false);
                    if(!tabel_riwayat.DataTable().$('input[type="checkbox"]').serializeObject()['id[]']){
                        $('#multiple-action').html('');
                    }
                });
            }) 
        })

        $('#riwayat_modal').on('click', '#btn-multiple-move', function(){
            if(!tabel_riwayat.DataTable().$('input[type="checkbox"]').serializeObject()['id[]']){
                generalAlert('Tidak ada realisasi yang terpilih.')
                return;
            }
            if(!$('#link_entry_detail').val()) socket.emit('pok_list', {'type': '', 'syarat': {}, 'sortby': 'kdprogram', 'for': 'riwayat_for_link'});
            $('#link_realisasi_modal').modal('show');
        })

        $('#btn-ubah-detail-submit').click(function(){
            if($('#link_entry_detail').val() && $('#link_entry_detail option:selected').text() != '--pilih--'){
                var checked = tabel_riwayat.DataTable().$('input[type="checkbox"]').serializeObject()['id[]'];
                if(typeof checked === 'string'){
                    checked = [checked];
                }
                $("#btn-ubah-detail-submit").html('<i class="fa fa-spinner fa-pulse fa-1x fa-fw font-lg"></i> '+$("#btn-ubah-detail-submit").html());
                $('#example-select-all').prop('checked', false);
                _.each(checked, function(id, index, list){
                    socket.emit('del_riwayat', {'parent_id': $("#tbh_entry_detail").val(), 'target_id': id, 
                        'new_parent_id': $('#link_entry_detail').val(), 'month': $('#bulan_realisasi').val()}, function(status){
                        var row_affected = tabel_riwayat.DataTable()
                                        .rows( function ( idx, data, node ) {
                                            return data[0] == id ?
                                                true : false;
                                        } )
                                        .nodes()
                                        .to$();
                        tabel_riwayat.DataTable().row(row_affected).remove().draw(false);
                        if(!tabel_riwayat.DataTable().$('input[type="checkbox"]').serializeObject()['id[]']){
                            $("#btn-ubah-detail-submit").html('Simpan');
                            $('#link_realisasi_modal').modal('toggle');
                            $('#multiple-action').html('');
                        }
                    });
                })
                $("#btn-multiple-delete").prop("disabled",false);
            }else {
                generalAlert('Detail belum dipilih.');
            }
        })

        //init bulan
        var current_month = new Date().getMonth()+1;
        $('#bulan_realisasi option:eq('+current_month+')').prop('selected', true);
        $('#bulan_realisasi_modal option:eq('+current_month+')').prop('selected', true);
        $('#download_pdf').attr('href', 'pok/download/pdf/'+(current_month-1));
        $('#download_xlsx').attr('href', 'pok/download/xlsx/'+(current_month-1));

        var riwayat_syarat;        
        $('#bulan_realisasi').change(function(){
            var selected = $(this).val();
            $('#download_pdf').attr('href', 'pok/download/pdf/'+selected);
            $('#download_xlsx').attr('href', 'pok/download/xlsx/'+selected);
            var exists = tabel_pok_entry.DataTable()
                        .rows( function ( idx, data, node ) {
                            return ((data[9] !== '-' && data[9] !== '0' && data[9] !== 0) || 
                                (data[10] !== '-' && data[10] !== '0' && data[10] !== 0) || 
                                (data[11] !== '-' && data[11] !== '0' && data[11] !== 0)) ?
                                true : false;
                            });
            _.each(exists.nodes().to$(), function(exist, index, list){
                var realisasi_td = tabel_pok_entry.DataTable().row(exist)
                                    .nodes()
                                    .to$();
                tabel_pok_entry.DataTable()
                    .cell(realisasi_td.find('td:eq(7)')).data('-')
                    .cell(realisasi_td.find('td:eq(8)')).data('-')
                    .cell(realisasi_td.find('td:eq(9)')).data('-');
            });
            if(selected == 'none') return;
            $('#bulan_realisasi_modal option:eq('+(+selected+1)+')').prop('selected', true);
            socket.emit('realisasi_change_month', selected);
        })
        
        $('#bulan_realisasi_modal').change(function(){
            if(!$('#tampil-riwayat-by-month').is(':checked')) return;
            tabel_riwayat.DataTable().clear().draw(false);
            var selected = $(this).val();
            if(selected == 'none') return;

            riwayat_syarat = {'detail_id': $('#tbh_entry_detail').val(), 'init': false, 
                'month': selected}
            socket.emit('riwayat_init', riwayat_syarat);
        });

        $('#riwayat-lower_ts, #riwayat-upper_ts').datetimepicker({
            locale: 'id',
            format: 'D MMMM YYYY',
            useCurrent: false,
            widgetPositioning: {
                horizontal: 'left',
                vertical: 'bottom'
            }
        });

        $('#riwayat-lower_ts, #riwayat-upper_ts').on('dp.change', function(e){
            if($('#tampil-riwayat-by-range').is(':checked')){
                if($('#riwayat-lower_ts').val() == '' || $('#riwayat-upper_ts').val() == '') return;
                tabel_riwayat.DataTable().clear().draw(false);
                var lower_ts = $('#riwayat-lower_ts').data('DateTimePicker').date().unix()
                var upper_ts = $('#riwayat-upper_ts').data('DateTimePicker').date().unix()
                riwayat_syarat = {'detail_id': $('#tbh_entry_detail').val(), 'init': false,
                    'lower_ts': lower_ts, 'upper_ts': upper_ts}
                socket.emit('riwayat_init', riwayat_syarat);
            }
        });

        $("input[name='tampil_riwayat']").change(function(e){
            if ($(this).val() == '0'){
                if($('#riwayat-lower_ts').val() == '' || $('#riwayat-upper_ts').val() == '') return;
                tabel_riwayat.DataTable().clear().draw(false);
                var lower_ts = $('#riwayat-lower_ts').data('DateTimePicker').date().unix()
                var upper_ts = $('#riwayat-upper_ts').data('DateTimePicker').date().unix()
                riwayat_syarat = {'detail_id': $('#tbh_entry_detail').val(), 'init': false,
                    'lower_ts': lower_ts, 'upper_ts': upper_ts}
                socket.emit('riwayat_init', riwayat_syarat);
            } else {
                tabel_riwayat.DataTable().clear().draw(false);
                var selected = $('#bulan_realisasi_modal').val();
                if(selected == 'none') return;
                riwayat_syarat = {'detail_id': $('#tbh_entry_detail').val(), 'init': false, 
                    'month': selected}
                socket.emit('riwayat_init', riwayat_syarat);
            }
        })

        //Tombol entry
        var detail_id_target;
        tabel_pok_entry.on('click', '.entry', function () {
            var all_row_target_td = tabel_pok_entry.DataTable().row($(this).closest('tr')).data();
            detail_id_target = all_row_target_td[0];
            $('.detail_blnj_entry').html(all_row_target_td[4])
            $('#pagu_entry_form').html(all_row_target_td[8])
            entry_modal.modal('show');
        });

        $('.penerima-autocomplete').typeahead({
                hint: true,
                highlight: true,
                minLength: 1
            }, {
                source: function(q, p){
                        {
                            socket.emit('penerima_list', q, function (data) {
                                return p(_.map(data, function(peg){ return {_id: peg._id, value: peg.nama}}))
                            });
                        }
                }
            }
        );
    
        $(".penerima-autocomplete").on("typeahead:selected typeahead:autocompleted", function(e,datum) {
             $('#entry_penerima_id_field').val(datum._id);
        });

        $('#entry_tgl_field').datetimepicker({
            locale: 'id',
            format: 'D MMMM YYYY',
            useCurrent: false,
            widgetPositioning: {
                horizontal: 'left',
                vertical: 'bottom'
            }
        });

        $('#entry_tgl_field').on('dp.change', function(e){
            var y = new Date().getFullYear();
             if(e.date) $('#entry_tgl_ts_field').val(e.date.unix())
        });

        function registerTypeaheadEntryElement(){
            $('.penerima-autocomplete').typeahead({
                    hint: true,
                    highlight: true,
                    minLength: 1
                }, {
                    source: function(q, p){
                            {
                                socket.emit('penerima_list', q, function (data) {
                                    return p(_.map(data, function(peg){ return {_id: peg._id, value: peg.nama}}))
                                });
                            }
                    }
                }
            );
        
            $(".penerima-autocomplete").on("typeahead:selected typeahead:autocompleted", function(e,datum) {
                 $('#entry_penerima_id_field').val(datum._id);
            });

            $('#entry_tgl_field').datetimepicker({
                locale: 'id',
                format: 'D MMMM YYYY',
                useCurrent: false,
                widgetPositioning: {
                    horizontal: 'left',
                    vertical: 'bottom'
                }
            });

            $('#entry_tgl_field').on('dp.change', function(e){
                 if(e.date) $('#entry_tgl_ts_field').val(e.date.unix())
            });

        }

        //focus field jumlah pd entry modal
        entry_modal.on('shown.bs.modal', function () {
          $('#entry_jumlah_field').focus();
          $(document).off('focusin.bs.modal');
        })

        //form entri: banyak penerima
        var import_data_entry;
        $("input[name='entri_banyak_penerima']").change(function(e){
            import_data_entry = null;
            var s = $(this).val();
            if(s == '1') {
                $('#modal-remove-lg').css('max-width', '')
                $('#modal-remove-lg').addClass('modal-lg');
                var show = '<div style="height: 480px;position:relative;">'
                            +    '<div style="max-height:100%;overflow-y:auto;overflow-x:hidden;">'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">Alokasi dana</label>'
                            +            '<div class="col-md-9">'
                            +                '<label class="radio-inline" for="alokasi_sama_radio">'
                            +                    '<input id="alokasi_sama_radio" type="radio" name="entri_alokasi" value="0" checked="checked">Beda'
                            +                '</label>'
                            +                '<label class="radio-inline" for="alokasi_beda_radio">'
                            +                    '<input id="alokasi_beda_radio" type="radio" name="entri_alokasi" value="1" style="margin-left: 10px">Sama'
                            +                '</label>'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">Jumlah<span> *</span></label>'
                            +            '<div class="col-md-2">'
                            +                '<input id="entry_jumlah_field" type="text" class="form-control format-uang" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">Penerima<span> *</span></label>'
                            +            '<div class="col-md-4">'
                            +                    '<input id="entry_penerima_name_field" type="text" class="form-control penerima-autocomplete" autocomplete="off">'
                            +                    '<span id="plus-button-alokasi-sama-bagi" class="input-group-btn">'
                            +                        '<button id="btn-plus-sama-bagi" type="button" class="btn btn-primary">+</button>'
                            +                    '</span>'
                            +                    '<input id="entry_penerima_id_field" style="display: none;" type="text">'
                            +           '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">Tanggal<span> *</span></label>'
                            +            '<div class="col-md-3">'
                            +                '<input id="entry_tgl_field" type="text" class="form-control" autocomplete="off">'
                            +                '<input id="entry_tgl_ts_field" style="display: none;" type="text" class="form-control">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">PPh 21</label>'
                            +            '<div class="col-md-2">'
                            +                '<input id="pph21" type="text" class="form-control format-uang" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">PPh 22</label>'
                            +            '<div class="col-md-2">'
                            +                '<input id="pph22" type="text" class="form-control format-uang" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">PPh 23</label>'
                            +            '<div class="col-md-2">'
                            +                '<input id="pph23" type="text" class="form-control format-uang" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">PPn</label>'
                            +            '<div class="col-md-2">'
                            +                '<input id="ppn" type="text" class="form-control format-uang" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">No. SPM</label>'
                            +            '<div class="col-md-2">'
                            +                '<input id="entry_spmno_field" type="text" class="form-control" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">No. Bukti</label>'
                            +            '<div class="col-md-2">'
                            +               '<input id="entry_buktino_field" type="text" class="form-control" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +           '<label class="col-md-2 form-control-label">Keterangan</label>'
                            +            '<div class="col-md-5">'
                            +                '<textarea id="entry_ket_field" rows="3" class="form-control"></textarea>'
                            +            '</div>'
                            +        '</div>'
                            +        '<div id="tambah-button-alokasi-beda" class="form-group row">'
                            +            '<div class="col-md-12">'
                            +                '<button id="btn-alokasi-beda" type="button">Tambah</button>'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="row">'
                            +            '<div class="col-md-12">'
                            +                '<table id="tbl_tambah_penerima" class="table" cellspacing="0" width="100%">'
                            +                    '<thead>'
                            +                       ' <tr>'
                            +                            '<th>Tgl_ts</th>'
                            +                            '<th>Penerima_id</th>'
                            +                            '<th class="default-sort-column">No.</th>'
                            +                            '<th>Tanggal</th>'
                            +                            '<th>Penerima</th>'
                            +                            '<th>Jumlah</th>'
                            +                            '<th>PPh 21</th>'
                            +                            '<th>PPh 22</th>'
                            +                            '<th>PPh 23</th>'
                            +                            '<th>PPn</th>'
                            +                            '<th>Nmr SPM</th>'
                            +                            '<th>Nmr Bukti</th>'
                            +                            '<th>Ket</th>'
                            +                            '<th>Pilihan</th>'
                            +                        '</tr>'
                            +                    '</thead>'
                            +                    '<tbody>'                     
                            +                    '</tbody>'
                            +                '</table>'
                            +            '</div>'
                            +        '</div>'
                            +    '</div>'
                            +'</div>'
                $('#fields_form_entry').html(
                    show
                )

                var jenis_alokasi = $("input[name='entri_alokasi']").val();
                if( jenis_alokasi == '0') {
                    $('#plus-button-alokasi-sama-bagi').hide();
                    $('#tambah-button-alokasi-beda').show();
                } else { 
                    $('#plus-button-alokasi-sama-bagi').show();
                    $('#tambah-button-alokasi-beda').hide();
                }

                //register datatable & editable table daftar penerima
                var tbl_tambah_penerima = $("#tbl_tambah_penerima");
                tbl_tambah_penerima.DataTable({
                    // scrollY:        false,
                    // scrollX:        true,
                    // scrollCollapse: true,
                    // fixedColumns:   {
                    //     leftColumns: 3,
                    //     rightColumns: 1
                    // },
                    columnDefs: [
                        {
                            "targets": [ 0,1 ],
                            "visible": false,
                            "searchable": false
                        }
                    ],
                    aaSorting: [],
                    rowReorder: {
                        enable: false
                    },
                    paging: false,
                    createdRow: function( row, data, dataIndex ) {
                        if(!data[6]){
                            $( row ).find('td:eq(4)').text('-');
                        }
                        if(!data[7]){
                            $( row ).find('td:eq(5)').text('-');
                        }
                        if(!data[8]){
                            $( row ).find('td:eq(6)').text('-');
                        }
                        if(!data[9]){
                            $( row ).find('td:eq(7)').text('-');
                        }
                        if(!data[10]){
                            $( row ).find('td:eq(8)').text('-');
                        }
                        if(!data[11]){
                            $( row ).find('td:eq(9)').text('-');
                        }
                        if(!data[12]){
                            $( row ).find('td:eq(10)').text('-');
                        }
                        if(!data[13]){
                            $( row ).find('td:eq(11)').text('-');
                        }
                        $( row ).find('td:eq(0)').attr('class', 'text-center').text(dataIndex+1);
                        $( row ).find('td:eq(1)').attr('class', 'text-center');
                        $( row ).find('td:eq(3)').attr('class', 'format-uang');
                        $( row ).find('td:eq(4)').attr('class', 'format-uang');
                        $( row ).find('td:eq(5)').attr('class', 'format-uang');
                        $( row ).find('td:eq(6)').attr('class', 'format-uang');
                        $( row ).find('td:eq(7)').attr('class', 'format-uang');
                        $( row ).find('td:eq(8)').attr('class', 'text-center');
                        $( row ).find('td:eq(9)').attr('class', 'text-center');
                        $( row ).find('td:eq(11)').attr('class', 'text-center');
                    }
                });
                $('#entry_jumlah_field').focus();
                registerTypeaheadEntryElement();
            } else if(s == '0'){
                $('#modal-remove-lg').css('max-width', '500px')
                $('#modal-remove-lg').removeClass('modal-lg');
                    var satu_penerima_fields = '<div class="form-group row">'
                            +    '<label class="col-md-3 form-control-label">Jumlah<span> *</span></label>'
                            +    '<div class="col-md-4">'
                            +        '<input id="entry_jumlah_field" type="text" class="form-control format-uang" autocomplete="off" required>'
                            +    '</div>'
                            +'</div>' 
                            +'<div class="form-group row">'
                            +    '<label class="col-md-3 form-control-label">Penerima<span> *</span></label>'
                            +    '<div class="col-md-9">'
                            +        '<input id="entry_penerima_name_field" type="text" class="form-control penerima-autocomplete" autocomplete="off" required>'
                            +        '<input id="entry_penerima_id_field" style="display: none;" type="text">'
                            +    '</div>'
                            +'</div>' 
                            +'<div class="form-group row">'
                            +    '<label class="col-md-3 form-control-label">Tanggal<span> *</span></label>'
                            +    '<div class="col-md-5">'
                            +        '<input id="entry_tgl_field" type="text" class="form-control" autocomplete="off" required>'
                            +        '<input id="entry_tgl_ts_field" style="display: none;" type="text" class="form-control">'
                            +    '</div>'
                            +'</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-3 form-control-label">PPh 21</label>'
                            +            '<div class="col-md-4">'
                            +                '<input id="pph21" type="text" class="form-control format-uang" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-3 form-control-label">PPh 22</label>'
                            +            '<div class="col-md-4">'
                            +                '<input id="pph22" type="text" class="form-control format-uang" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-3 form-control-label">PPh 23</label>'
                            +            '<div class="col-md-4">'
                            +                '<input id="pph23" type="text" class="form-control format-uang" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-3 form-control-label">PPn</label>'
                            +            '<div class="col-md-4">'
                            +                '<input id="ppn" type="text" class="form-control format-uang" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +'<div class="form-group row">'
                            +    '<label class="col-md-3 form-control-label">No. SPM</label>'
                            +    '<div class="col-md-4">'
                            +        '<input id="entry_spmno_field" type="text" class="form-control" autocomplete="off">'
                            +    '</div>'
                            +'</div>'
                            +'<div class="form-group row">'
                            +    '<label class="col-md-3 form-control-label">No. Bukti</label>'
                            +    '<div class="col-md-4">'
                            +        '<input id="entry_buktino_field" type="text" class="form-control" autocomplete="off">'
                            +    '</div>'
                            +'</div>' 
                            +'<div class="form-group row">'
                            +    '<label class="col-md-3 form-control-label">Keterangan</label>'
                            +    '<div class="col-md-9">'
                            +        '<textarea id="entry_ket_field" rows="3" class="form-control"></textarea>'
                            +    '</div>'
                            +'</div>'
                $('#fields_form_entry').html(
                    satu_penerima_fields
                )
                $('#entry_jumlah_field').focus();
                registerTypeaheadEntryElement();
            } else {
                $('#modal-remove-lg').css('max-width', '')
                $('#modal-remove-lg').addClass('modal-lg');
                var show = '<div style="height: 480px;position:relative;">'
                            +    '<div style="max-height:100%;overflow-y:auto;overflow-x:hidden;">'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">Tanggal<span> *</span></label>'
                            +            '<div class="col-md-3">'
                            +                '<input id="entry_tgl_field" type="text" class="form-control" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">No. SPM</label>'
                            +            '<div class="col-md-2">'
                            +                '<input id="entry_spmno_field" type="text" class="form-control" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<label class="col-md-2 form-control-label">No. Bukti</label>'
                            +            '<div class="col-md-2">'
                            +               '<input id="entry_buktino_field" type="text" class="form-control" autocomplete="off">'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +           '<label class="col-md-2 form-control-label">Keterangan</label>'
                            +            '<div class="col-md-5">'
                            +                '<textarea id="entry_ket_field" rows="3" class="form-control"></textarea>'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<div class="col-md-12">'
                            +                '<button id="btn-set-import-data" type="button">Set</button>'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="form-group row">'
                            +            '<div class="col-md-12">'
                            +                '<p>Jumlah: <span id="jumlah-spreadsheed"></span></p>'
                            +            '</div>'
                            +        '</div>'
                            +        '<div class="row">'
                            +            '<div class="col-md-12">'
                            +                '<div id="spreadsheet_entry" style="height: 640px; width: 1200px; overflow: auto;">'
                            +                '</div>'
                            +            '</div>'
                            +        '</div>'
                            +    '</div>'
                            +'</div>'
                $('#fields_form_entry').html(
                    show
                )              

                $('#entry_tgl_field').datetimepicker({
                    locale: 'id',
                    format: 'D MMMM YYYY',
                    useCurrent: false,
                    widgetPositioning: {
                        horizontal: 'left',
                        vertical: 'bottom'
                    }
                });

                var new_entry = {};
                new_entry._id = detail_id_target;
                new_entry.timestamp = Math.round(new Date().getTime()/1000);
                new_entry.month = $('#bulan_realisasi').val();

                var container = document.getElementById('spreadsheet_entry');

                import_data_entry = new Handsontable(container, {
                  data: [],
                  dataSchema: {tgl_timestamp: null, penerima_id: null, tgl: null, penerima_nama: null,
                    jumlah: null, pph21 : null, pph22 : null, pph23 : null, ppn : null, spm_no : null, bukti_no : null, ket : null},
                  rowHeaders: true,
                  colHeaders: true,
                  startCols: 10,
                  minCols: 10,
                  maxCols: 10,
                  colWidths: [125, 200, 93, 93, 93, 93, 93, 93, 93, 95],
                  manualColumnResize: true,
                  minSpareRows: 1,
                  colHeaders: ["Tanggal", "Penerima", "Jumlah", "PPh 21", "PPh 22", "PPh 23", "PPn", "Nmr SPM", "Nmr Bukti", "Ket"],
                  columns: [
                    {data: 'tgl', readOnly: true},
                    {
                        type: 'autocomplete',
                        source: function (query, process) {
                            socket.emit('penerima_list', {'query': query, 'type': 'all'}, function (data) {
                                // return p(_.map(data, function(peg){ return {_id: peg._id, value: peg.nama}}))
                                process(_.map(data, function(peg){ return peg.nama}));
                            });
                        },
                        data: 'penerima_nama',
                        strict: false
                    },
                    {data: 'jumlah', format: '_(* #,##0_);_(* (#,##0);_(* "-"_);_(@_)', type: 'numeric'},
                    {data: 'pph21', format: '_(* #,##0_);_(* (#,##0);_(* "-"_);_(@_)', type: 'numeric'},
                    {data: 'pph22', format: '_(* #,##0_);_(* (#,##0);_(* "-"_);_(@_)', type: 'numeric'},
                    {data: 'pph23', format: '_(* #,##0_);_(* (#,##0);_(* "-"_);_(@_)', type: 'numeric'},
                    {data: 'ppn', format: '_(* #,##0_);_(* (#,##0);_(* "-"_);_(@_)', type: 'numeric'},
                    {data: 'spm_no'},
                    {data: 'bukti_no'},
                    {data: 'ket'},
                    {data: 'tgl_timestamp'},
                    {data: 'penerima_id'}
                  ],
                  hiddenColumns: {
                      columns: [0, 1]
                    },
                  contextMenu: true
                });

                Handsontable.hooks.add('afterChange', function(changes, source){
                    var jumlah = 0;
                    if(!import_data_entry) return;
                    var data = import_data_entry.getSourceData();
                    _.each(changes, function(change, index, list){
                        if(_.contains(['jumlah', 'pph21', 'pph22', 'pph23', 'ppn'], change[1])){
                            if (typeof change[3] === 'string' || change[3] instanceof String)
                                data[change[0]][change[1]] = change[3].replace(/\D/g, '')

                            if(data[change[0]][change[1]] < 0) data[change[0]][change[1]] *= -1;
                        }
                    })
                    import_data_entry.render();
                    if(import_data_entry.getSourceData()[0].tgl_timestamp){
                        _.each(changes, function(change, index, list){
                            if((change[3] == '' && (change[1] == 'penerima_nama' || change[1] == 'jumlah'))
                                    || !import_data_entry.getSourceData()[change[0]].penerima_nama ||
                                    !import_data_entry.getSourceData()[change[0]].jumlah){
                                data[change[0]].tgl_timestamp = ''
                                data[change[0]].tgl = ''
                                return;
                            }
                            data[change[0]].tgl_timestamp = data[0].tgl_timestamp
                            data[change[0]].tgl = data[0].tgl
                        });
                        import_data_entry.render();                        
                    }
                    _.each(import_data_entry.getSourceData(), function(row, index, list){
                        jumlah += getNumber(row.jumlah || 0);
                    });
                    $('#jumlah-spreadsheed').text(formatUang(jumlah));
                });

                $('#btn-set-import-data').click(function(e){
                    if(import_data_entry){
                        var data = import_data_entry.getSourceData();
                        _.each(data, function(new_entry, index, list){
                            if(index == data.length - 1) return;
                            if(!new_entry.penerima_nama) return;
                            if($('#entry_tgl_field').data('DateTimePicker').date()) new_entry.tgl_timestamp = $('#entry_tgl_field').data('DateTimePicker').date().unix();
                            new_entry.spm_no = $('#entry_spmno_field').val();
                            // new_entry.pph21 = $('#pph21').val();
                            // new_entry.pph22 = $('#pph22').val();
                            // new_entry.pph23 = $('#pph23').val();
                            new_entry.ppn = $('#ppn').val();
                            new_entry.tgl = $('#entry_tgl_field').val();
                            new_entry.bukti_no = $('#entry_buktino_field').val();
                            new_entry.ket = $('#entry_ket_field').val();
                        });
                        import_data_entry.render();
                    }
                });

            }
        });

        //Inline editor tambah penerima banyak
        var state_active_editor_tbh_penerima = false;
        var editor_tbh_penerima;
        var active_tbh_penerima;
        $('#fields_form_entry').on('dblclick', 'table#tbl_tambah_penerima tr td', function () {
            active_tbh_penerima = $(this);
            if(state_active_editor_tbh_penerima || active_tbh_penerima.is(':nth-child(1)') || active_tbh_penerima.is(':nth-child(12)')){
                $.toast({
                    text: 'Anda tidak dapat mengedit sel tersebut.',
                    textAlign: 'left', 
                    hideAfter: 1000,
                    loader: false,
                    position: 'bottom-right',
                    allowToastClose: false
                })
                return;
            }
            state_active_editor_tbh_penerima = true;
            var cloneProperties = ['padding', 'padding-top', 'padding-bottom', 'padding-left', 'padding-right',
                          'text-align', 'font', 'font-size', 'font-family', 'font-weight',
                          'border', 'border-top', 'border-bottom', 'border-left', 'border-right'];
            if(active_tbh_penerima.hasClass('format-uang')){
                editor_tbh_penerima = $('<input type="text" class="format-uang">').val(getNumber(active_tbh_penerima.text())).hide().appendTo(active_tbh_penerima.parent());
            } else if(active_tbh_penerima.is(':nth-child(2)')) {
                editor_tbh_penerima = $('<input type="text" class="date">').val(active_tbh_penerima.text()).hide().appendTo(active_tbh_penerima.parent());
                editor_tbh_penerima.datetimepicker({
                    locale: 'id',
                    format: 'D MMMM YYYY',
                    useCurrent: false,
                    widgetPositioning: {
                        horizontal: 'left',
                        vertical: 'top'
                    }
                });
            }  else if(active_tbh_penerima.is(':nth-child(3)')) {
                editor_tbh_penerima = $('<input type="text" class="penerima-autocomplete">').val(active_tbh_penerima.text()).hide().appendTo(active_tbh_penerima.parent());
                editor_tbh_penerima.typeahead({
                        hint: true,
                        highlight: true,
                        minLength: 1
                    }, {
                        source: function(q, p){
                                {
                                    socket.emit('penerima_list', q, function (data) {
                                        return p(_.map(data, function(peg){ return {_id: peg._id, value: peg.nama}}))
                                    });
                                }
                        }
                    }
                );
                active_tbh_penerima.css('visibility','hidden');
            } else {
                editor_tbh_penerima = $('<textarea></textarea>').val(active_tbh_penerima.text()).hide().appendTo(active_tbh_penerima.parent());
            }

            editor_tbh_penerima.css('position', 'absolute');
            editor_tbh_penerima
                .show()
                .offset(active_tbh_penerima.offset())
                .css(active_tbh_penerima.css(cloneProperties))
                .width(active_tbh_penerima.width())
                .height(active_tbh_penerima.height())
                .focus();
            editor_tbh_penerima.select();
        });

        var date_field_timestamp_temp_tbh_penerima; //temp nilai timestamp tgl utk edit penerima
        $('#fields_form_entry').on('dp.change', '.date', function(e){
            date_field_timestamp_temp_tbh_penerima = e.date.unix();
        });

        var penerima_id_temp_tbh_penerima;
        $('#fields_form_entry').on("typeahead:selected typeahead:autocompleted", ".penerima-autocomplete", function(e,datum) {
             penerima_id_temp_tbh_penerima = datum._id;
        });

        $('#fields_form_entry').on('blur keydown', 'table#tbl_tambah_penerima input, table#tbl_tambah_penerima textarea', function (e) {
            //jika enter anggap blur (krn klo tidak, di fired 2 kali)
            if (e.which === 13){
                $(this).blur();
            } else if (e.which === 0){//jika blur ==> keycode nya 0
                if(!active_tbh_penerima) return;
                if(editor_tbh_penerima.val() !== active_tbh_penerima.text()){
                    if(editor_tbh_penerima.val() == ''){
                        editor_tbh_penerima.val('-');
                    }
                    
                    if(active_tbh_penerima.is(':nth-child(2)')) {
                        var row = $('#tbl_tambah_penerima').DataTable().row(active_tbh_penerima.closest('tr'));
                        var data_temp = row.data();
                        data_temp[0] = date_field_timestamp_temp_tbh_penerima;
                        data_temp[2] = active_tbh_penerima.prev().text();
                        data_temp[3] = editor_tbh_penerima.val();
                        row.data(data_temp).draw(false);
                    } else if(active_tbh_penerima.is(':nth-child(3)')) {
                        active_tbh_penerima.css('visibility','visible');
                        var row = $('#tbl_tambah_penerima').DataTable().row(active_tbh_penerima.closest('tr'));
                        var data_temp = row.data();
                        data_temp[1] = penerima_id_temp_tbh_penerima;
                        data_temp[2] = active_tbh_penerima.prev().prev().text();
                        data_temp[4] = editor_tbh_penerima.val();
                        row.data(data_temp).draw(false);
                    } else {
                        $('#tbl_tambah_penerima').DataTable()
                            .cell(active_tbh_penerima)
                            .data(editor_tbh_penerima.val())
                            .draw(false);  
                    }                                    
                }
                active_tbh_penerima = null;
                state_active_editor_tbh_penerima = false;
                editor_tbh_penerima.hide();
            } else if(e.which === 27){
                active_tbh_penerima = null;
                state_active_editor_tbh_penerima = false;
                editor_tbh_penerima.hide();
            }
        });

        //form entri - banyak penerima: jenis alokasi
        $('#plus-button-alokasi-sama-bagi').hide();
        entry_modal.on('change', "input[name='entri_alokasi']", function () {
            var jenis_alokasi = $(this).val();
            if( jenis_alokasi == '0') {
                $('#plus-button-alokasi-sama-bagi').hide();
                $('#tambah-button-alokasi-beda').show();
            } else { 
                $('#plus-button-alokasi-sama-bagi').show();
                $('#tambah-button-alokasi-beda').hide();
            }
        });

        function checkField(){
            if($("#entry_tgl_field").val() == ''||$("#entry_penerima_name_field").val() == ''|| $("#entry_jumlah_field").val()== ''){
                return false;
            } else {
                return true;
            }
        }

        //form entri - banyak penerima: plus btn
        entry_modal.on('click', "#btn-plus-sama-bagi", function () {
            if(!checkField()){
                $.toast({
                    text: 'Mohon cek isian wajib.',
                    textAlign: 'left', 
                    hideAfter: 1000,
                    loader: false,
                    position: 'bottom-right',
                    allowToastClose: false
                })
                return;
            }
            var tbl_tambah_penerima = $("#tbl_tambah_penerima");
            tbl_tambah_penerima.DataTable().row.add( [
                $("#entry_tgl_ts_field").val(),
                $("#entry_penerima_id_field").val(),
                '',
                $("#entry_tgl_field").val(),
                $("#entry_penerima_name_field").val(),
                $("#entry_jumlah_field").val(),
                $("#pph21").val(),
                $("#pph22").val(),
                $("#pph23").val(),
                $("#ppn").val(),
                $("#entry_spmno_field").val(),
                $("#entry_buktino_field").val(),
                $("#entry_ket_field").val(),
                '<button type="button" class="del-penerima-tbl"><i class="icon-close"></i></button>'
            ] ).draw( false );
            $("#entry_penerima_name_field").val('');
            $("#entry_penerima_id_field").val('');
            $("#entry_penerima_name_field").focus();
        });
        //form entri - banyak penerima: tambah btn
        entry_modal.on('click', "#btn-alokasi-beda", function () {
            if(!checkField()){
                $.toast({
                    text: 'Mohon cek isian wajib.',
                    textAlign: 'left', 
                    hideAfter: 1000,
                    loader: false,
                    position: 'bottom-right',
                    allowToastClose: false
                })
                return;
            }
            var tbl_tambah_penerima = $("#tbl_tambah_penerima");
            tbl_tambah_penerima.DataTable().row.add( [
                $("#entry_tgl_ts_field").val(),
                $("#entry_penerima_id_field").val(),
                '',
                $("#entry_tgl_field").val(),
                $("#entry_penerima_name_field").val(),
                $("#entry_jumlah_field").val(),
                $("#pph21").val(),
                $("#pph22").val(),
                $("#pph23").val(),
                $("#ppn").val(),
                $("#entry_spmno_field").val(),
                $("#entry_buktino_field").val(),
                $("#entry_ket_field").val(),
                '<button type="button" class="del-penerima-tbl"><i class="icon-close"></i></button>'
            ] ).draw( false );
            $("#entry_jumlah_field").val('');
            $("#entry_penerima_name_field").val('');
            $("#entry_tgl_field").val('');
            $('#entry_jumlah_field').focus();
        });
        //form entri - banyak penerima: hapus pggna btn
        entry_modal.on('click', ".del-penerima-tbl", function () {
            // var item = $(this).closest('tr');
            // item.remove();
            $("#tbl_tambah_penerima").DataTable().row( $(this).parents('tr') )
            .remove()
            .draw(false);
        });

        //submit entry
        form_entri_pok.on('submit', function(e) {
            e.preventDefault();
            $("#entri_submit").prop("disabled",true);
            $("#entri_submit").html('<i class="fa fa-spinner fa-pulse fa-1x fa-fw"></i> '+$("#entri_submit").text());
            var s = $("input[name='entri_banyak_penerima']:checked").val();

            if(s == '0'){
                var new_entry = {};
                new_entry._id = detail_id_target;
                var spm = $("#entry_spmno_field").val();
                var tgl_ = $("#entry_tgl_field").val()
                //init autonumeric spy bisa get unformatted[workaround]
                $('#pph21, #pph22, #pph23, #ppn').autoNumeric('init', {digitGroupSeparator: ',', decimalCharacter: '.', decimalPlacesOverride: '0'});
                new_entry.data = {
                    timestamp: Math.round(new Date().getTime()/1000),
                    jumlah : $("#entry_jumlah_field").autoNumeric('getNumber'),
                    penerima_id : $("#entry_penerima_id_field").val(),
                    tgl_timestamp : $('#entry_tgl_field').data('DateTimePicker').date().unix(),
                    tgl : $("#entry_tgl_field").val(),
                    penerima_nama : $("#entry_penerima_name_field").val(),
                    pph21 : $("#pph21").autoNumeric('getNumber'),
                    pph22 : $("#pph22").autoNumeric('getNumber'),
                    pph23 : $("#pph23").autoNumeric('getNumber'),
                    ppn : $("#ppn").autoNumeric('getNumber'),
                    spm_no : spm,
                    bukti_no : $("#entry_buktino_field").val(),
                    ket : $("#entry_ket_field").val()
                }
                new_entry.month = $('#bulan_realisasi').val();
                socket.emit('entry_submit', new_entry, function(status){
                    $("#entri_submit").html('Simpan');
                    form_entri_pok[0].reset();
                    $("#entry_spmno_field").val(spm)
                    $("#entry_tgl_field").val(tgl_)
                    $('#entry_penerima_id_field').val('');
                    $('#entry_jumlah_field').focus();
                    $("#entri_submit").prop("disabled",false);
                    if(status == 'sukses'){
                        //generalAlert('Berhasil disimpan.');
                    } else {
                        generalAlert(status);
                    }
                })
            } else if(s == '1'){
                var rows = $("#tbl_tambah_penerima").DataTable().rows();
                if(rows.nodes().to$().length == 0){
                    generalAlert('Belum ada data yang diiput.')
                    $("#entri_submit").html('Simpan');
                    $("#entri_submit").prop("disabled",false);
                    return;
                }
                var current_timestamp = Math.round(new Date().getTime()/1000);
                _.each(rows.nodes().to$(), function(row, index, list){
                    var data = $("#tbl_tambah_penerima").DataTable().row(row).data();
                    var new_entry = {};
                    new_entry._id = detail_id_target;
                    new_entry.data = {
                        timestamp: current_timestamp,
                        jumlah : getNumber(data[5]),
                        pph21 : getNumber(data[6]),
                        pph22 : getNumber(data[7]),
                        pph23 : getNumber(data[8]),
                        ppn : getNumber(data[9]),
                        penerima_id : data[1],
                        tgl_timestamp : data[0],
                        tgl : data[3],
                        penerima_nama : data[4],
                        spm_no : data[10],
                        bukti_no : data[11],
                        ket : data[12]
                    }
                    new_entry.month = $('#bulan_realisasi').val();
                    socket.emit('entry_submit', new_entry, function(status){
                        $("#entri_submit").html('Simpan');
                        $("#entri_submit").prop("disabled",false);
                        if(status == 'sukses'){
                            //generalAlert('Berhasil disimpan.');
                        } else {
                            generalAlert(status);
                        }
                    })
                });
                $("#tbl_tambah_penerima").DataTable().clear().draw(false);
            } else {
                var data = import_data_entry.getSourceData();
                if(data.length < 2){
                    generalAlert('Belum ada data yang diiput.')
                    $("#entri_submit").html('Simpan');
                    $("#entri_submit").prop("disabled",false);
                    return;
                }
                for (var i = data.length-2; i > -1; i--) {
                    if(isNotSaveable(data[i].tgl) && isNotSaveable(data[i].penerima_nama) && isNotSaveable(data[i].jumlah)){
                        import_data_entry.alter('remove_row', i);
                        continue;
                    }
                    if(isNotSaveable(data[i].tgl)){
                        generalAlert('Baris '+(i+1)+': Tanggal blm terisi.')
                        $("#entri_submit").html('Simpan');
                        $("#entri_submit").prop("disabled",false);
                        return;
                    }
                    if(isNotSaveable(data[i].penerima_nama)){
                        generalAlert('Baris '+(i+1)+': Penerima blm terisi')
                        $("#entri_submit").html('Simpan');
                        $("#entri_submit").prop("disabled",false);
                        return;
                    }
                    if(isNotSaveable(data[i].jumlah)){
                        generalAlert('Baris '+(i+1)+': Jumlah kosong/nol')
                        $("#entri_submit").html('Simpan');
                        $("#entri_submit").prop("disabled",false);
                        return;
                    }
                }

                var new_entry = {};
                new_entry.data = data;
                new_entry.timestamp = Math.round(new Date().getTime()/1000);
                new_entry._id = detail_id_target;
                new_entry.month = $('#bulan_realisasi').val();
                new_entry.import = true;

                socket.emit('entry_submit', new_entry, function(status){
                    $("#entri_submit").html('Simpan');
                    $("#entri_submit").prop("disabled",false);

                    if(status == 'sukses'){
                        import_data_entry.updateSettings({
                            data : []
                        });
                        //generalAlert('Berhasil disimpan.');
                    } else {
                        generalAlert(status);
                    }
                })
            }
        });

        function isNotSaveable(obj){
            if(!obj || obj == '' || obj == 0 || obj == '0' || obj == {} || obj == []) return true;
                else return false;
        }
        var target = document.getElementById('entrychild');
        var target2 = document.getElementById('utamachild');
        var spinner = new Spinner(opts);
        //Tombol riwayat
        var detail_id_target_riwayat;
        tabel_pok_entry.on('click', '.riwayat', function () {
            spinner.spin(target);
            //remove tombol multiple hapus
            $('#example-select-all').prop('checked', false);
            $('#multiple-action').html('');
            //clear semua row sblm ditambahkan
            tabel_riwayat.DataTable().clear().draw(false);
            var all_row_target_td = tabel_pok_entry.DataTable().row($(this).closest('tr')).data();
            detail_id_target_riwayat = all_row_target_td[0];
            var selected = $('#bulan_realisasi').val();
            $('#bulan_realisasi_modal option:eq('+(+selected+1)+')').prop('selected', true);
            riwayat_syarat = {'detail_id': detail_id_target_riwayat, 'init': true, 'month': selected}
            detail_name = all_row_target_td[4];
            socket.emit('riwayat_init', riwayat_syarat, function (data) {
                populateSelect(data.details, 'detail');
                populateSelect(data.akuns, 'akun');
                populateSelect(data.skomps, 'skomponen');
                populateSelect(data.komps, 'komponen');
                populateSelect(data.souts, 'soutput');
                populateSelect(data.outs, 'output');
                populateSelect(data.kegs, 'kegiatan');
                populateSelect(data.progs, 'program');
                spinner.stop();
            });

            $('.detail_blnj_riwayat').html(all_row_target_td[4])
            riwayat_modal.modal('show');
        });

        //add row ke tabel riwayat
        socket.on('riwayat_tbl_add', function(item) {
            tabel_riwayat.DataTable().row.add( item ).draw(false);
        });

        //jika dropdown berubah
        $('.pok-entry-dropdown').change(function(){
            detail_id_target_riwayat = null;

            var type = $(this).attr('id').match(/tbh_entry_(.*)/)[1];

            var kode;
            if(!$("#tbh_entry_"+type+" option:selected").text().match(/\s?\w+(?=\s)/)) return;

            if(type != 'skomponen') kode = $("#tbh_entry_"+type+" option:selected").text().match(/\d+(?=\s)/)[0]
                else kode = $("#tbh_entry_"+type+" option:selected").text().match(/\s?\w+(?=\s)/)[0]

            var syarat = {};
            var sortby;

            if(type == 'program'){
                syarat.kdprogram = kode;
                sortby = 'kdgiat';
                $('#tbh_entry_kegiatan').empty();
                $('#tbh_entry_output').empty();
                $('#tbh_entry_soutput').empty();
                $('#tbh_entry_komponen').empty();
                $('#tbh_entry_skomponen').empty();
                $('#tbh_entry_akun').empty();
                $('#tbh_entry_detail').empty();
            } else if(type == 'kegiatan'){
                syarat.kdprogram = $("#tbh_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = kode;
                sortby = 'kdoutput';
                $('#tbh_entry_output').empty();
                $('#tbh_entry_soutput').empty();
                $('#tbh_entry_komponen').empty();
                $('#tbh_entry_skomponen').empty();
                $('#tbh_entry_akun').empty();
                $('#tbh_entry_detail').empty();
            } else if(type == 'output'){
                syarat.kdprogram = $("#tbh_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = kode;
                sortby = 'kdsoutput';
                $('#tbh_entry_soutput').empty();
                $('#tbh_entry_komponen').empty();
                $('#tbh_entry_skomponen').empty();
                $('#tbh_entry_akun').empty();
                $('#tbh_entry_detail').empty();
            } else if(type == 'soutput'){
                syarat.kdprogram = $("#tbh_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#tbh_entry_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = kode;
                sortby = 'kdkmpnen';
                $('#tbh_entry_komponen').empty();
                $('#tbh_entry_skomponen').empty();
                $('#tbh_entry_akun').empty();
                $('#tbh_entry_detail').empty();
            } else if(type == 'komponen'){
                syarat.kdprogram = $("#tbh_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#tbh_entry_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = $("#tbh_entry_soutput option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdkmpnen = kode;
                sortby = 'kdskmpnen';
                $('#tbh_entry_skomponen').empty();
                $('#tbh_entry_akun').empty();
                $('#tbh_entry_detail').empty();
            } else if(type == 'skomponen'){
                syarat.kdprogram = $("#tbh_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#tbh_entry_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = $("#tbh_entry_soutput option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdkmpnen = $("#tbh_entry_komponen option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdskmpnen = kode;
                sortby = 'kdakun';
                $('#tbh_entry_akun').empty();
                $('#tbh_entry_detail').empty();
            } else if(type == 'akun'){
                syarat.kdprogram = $("#tbh_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#tbh_entry_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = $("#tbh_entry_soutput option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdkmpnen = $("#tbh_entry_komponen option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdskmpnen = $("#tbh_entry_skomponen option:selected").text().match(/\s?\w+(?=\s)/)[0];
                syarat.kdakun = kode
                sortby = 'noitem'
                $('#tbh_entry_detail').empty();
            }

            socket.emit('pok_list', {'type': type, 'syarat': syarat, 'sortby': sortby, 'for': 'riwayat'});
            tabel_riwayat.DataTable().clear().draw(false);
        })
        
        //tambah list
        socket.on('pok_list_for_riwayat', function(data) {
            populateSelect(data.items, data.type);
        })

        //dropdown detail berubah
        $('#tbh_entry_detail').change(function(){
            tabel_riwayat.DataTable().clear().draw(false);
            if($('#tbh_entry_detail').val() == '--pilih--') return;
            if($('#tampil-riwayat-by-month').is(':checked')){
                riwayat_syarat = {'detail_id': $('#tbh_entry_detail').val(), 'init': false, 
                    'month': $('#bulan_realisasi_modal').val()}
                socket.emit('riwayat_init', riwayat_syarat);
            } else {
                if($('#riwayat-lower_ts').val() == '' || $('#riwayat-upper_ts').val() == ''){
                    generalAlert('Periode realisasi belum ditentukan.')
                    return;
                }
                var lower_ts = $('#riwayat-lower_ts').data('DateTimePicker').date().unix()
                var upper_ts = $('#riwayat-upper_ts').data('DateTimePicker').date().unix()
                riwayat_syarat = {'detail_id': $('#tbh_entry_detail').val(), 'init': false,
                    'lower_ts': lower_ts, 'upper_ts': upper_ts}
                socket.emit('riwayat_init', riwayat_syarat);
            }
        })

        var detail_name;
        $('#download_xlsx2').click(function(){
            riwayat_syarat.pdf = false;
            riwayat_syarat.xlsx = true;
            riwayat_syarat.detail = detail_name;
            if($('#tampil-riwayat-by-range').is(':checked')){
                if($('#riwayat-lower_ts').val() == '' || $('#riwayat-upper_ts').val() == ''){
                    generalAlert('Periode ada yang kosong.');
                    return;
                } 
                riwayat_syarat.periode = $('#riwayat-lower_ts').val() + ' - ' + $('#riwayat-upper_ts').val();
            } else {
                var selected = $('#bulan_realisasi_modal option:selected').text();
                if(selected == '--pilih--'){
                    generalAlert('Bulan belum dipilih.');
                    return;
                }
                riwayat_syarat.periode = selected;
            }
            socket.emit('riwayat_init', riwayat_syarat, function(link){
                if(!link){
                    generalAlert('Tidak ada data.');
                    return;
                }
                window.open(location.protocol+"//"+$(location).attr('host')+link,'_blank');
            });
        })

        $('#download_pdf2').click(function(){
            riwayat_syarat.xlsx = false;
            riwayat_syarat.pdf = true;
            riwayat_syarat.detail = detail_name;
            if($('#tampil-riwayat-by-range').is(':checked')){
                if($('#riwayat-lower_ts').val() == '' || $('#riwayat-upper_ts').val() == ''){
                    generalAlert('Periode ada yang kosong.');
                    return;
                } 
                riwayat_syarat.periode = $('#riwayat-lower_ts').val() + ' - ' + $('#riwayat-upper_ts').val();
            } else {
                var selected = $('#bulan_realisasi_modal option:selected').text();
                if(selected == '--pilih--'){
                    generalAlert('Bulan belum dipilih.');
                    return;
                }
                riwayat_syarat.periode = selected;
            }
            socket.emit('riwayat_init', riwayat_syarat, function(link){
                if(!link){
                    generalAlert('Tidak ada data.');
                    return;
                }
                window.open(location.protocol+"//"+$(location).attr('host')+link,'_blank');
            });
        })

        //fungsi umum tambah list
        function populateSelect(lists, type){
            var options ='<option>'
                        +   '--pilih--'
                        +'</option>';
            var child_row;
            if(detail_id_target_riwayat){
                child_row = tabel_pok_entry.DataTable()
                    .rows( function ( idx, data, node ) {
                        return data[0] == detail_id_target_riwayat ?
                            true : false;
                    } );
            }
            
            _.each(lists, function(item, index, list){
                if(type == 'program'){
                    if(!detail_id_target_riwayat){
                        options +='<option value="'+item._id+'">'
                                +   item.kdprogram+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else if(item._id !== child_row.data()[0][1]){
                        options +='<option value="'+item._id+'">'
                                +   item.kdprogram+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.kdprogram+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                        detail_id_target_riwayat = item._id;
                    }                    
                } else if(type == 'kegiatan'){
                    if(!detail_id_target_riwayat){
                        options +='<option value="'+item._id+'">'
                                +   item.kdgiat+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else if(item._id !== child_row.data()[0][1]){
                        options +='<option value="'+item._id+'">'
                                +   item.kdgiat+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.kdgiat+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                        detail_id_target_riwayat = item._id;
                    }                    
                } else if(type == 'output'){
                    if(!detail_id_target_riwayat){
                        options +='<option value="'+item._id+'">'
                                +   item.kdoutput+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else if(item._id !== child_row.data()[0][1]){
                        options +='<option value="'+item._id+'">'
                                +   item.kdoutput+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.kdoutput+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                        detail_id_target_riwayat = item._id;
                    }                    
                } else if(type == 'soutput'){
                    if(!detail_id_target_riwayat){
                        options +='<option value="'+item._id+'">'
                                +   item.kdsoutput+' '+item.ursoutput
                                + '</option>';
                    } else if(lists.length == 1 || item._id == child_row.data()[0][1]){
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.kdsoutput+' '+item.ursoutput
                                + '</option>';
                    } else {
                        options +='<option value="'+item._id+'">'
                                +   item.kdsoutput+' '+item.ursoutput
                                + '</option>';
                        detail_id_target_riwayat = item._id;
                    }
                } else if(type == 'komponen'){
                    if(!detail_id_target_riwayat){
                        options +='<option value="'+item._id+'">'
                                +   item.kdkmpnen+' '+item.urkmpnen
                                + '</option>';
                    } else if(item._id !== child_row.data()[0][1]){
                        options +='<option value="'+item._id+'">'
                                +   item.kdkmpnen+' '+item.urkmpnen
                                + '</option>';
                    } else{
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.kdkmpnen+' '+item.urkmpnen
                                + '</option>';
                        detail_id_target_riwayat = item._id;
                    }
                    
                } else if(type == 'skomponen'){
                    if(!detail_id_target_riwayat){
                        options +='<option value="'+item._id+'">'
                            +   item.kdskmpnen+' '+item.urskmpnen
                            + '</option>';
                    } else if(lists.length == 1 || item._id == child_row.data()[0][1]){
                        options +='<option value="'+item._id+'" selected="selected">'
                            +   item.kdskmpnen+' '+item.urskmpnen
                            + '</option>';
                    } else{
                        options +='<option value="'+item._id+'">'
                            +   item.kdskmpnen+' '+item.urskmpnen
                            + '</option>';
                        detail_id_target_riwayat = item._id;
                    }
                } else if(type == 'akun'){
                    if(!detail_id_target_riwayat){
                        options +='<option value="'+item._id+'">'
                            +   item.kdakun+' '+(item.uraian || '[uraian blm ada]')
                            + '</option>';
                    } else if(item._id !== child_row.data()[0][1]){
                        options +='<option value="'+item._id+'">'
                            +   item.kdakun+' '+(item.uraian || '[uraian blm ada]')
                            + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                            +   item.kdakun+' '+(item.uraian || '[uraian blm ada]')
                            + '</option>';
                        detail_id_target_riwayat = item._id;
                    }
                } else if(type == 'detail'){
                    if(!detail_id_target_riwayat){
                        options +='<option value="'+item._id+'">'
                                +   item.noitem+' '+item.nmitem
                                + '</option>';
                    } else if(item._id !== detail_id_target_riwayat){
                        options +='<option value="'+item._id+'">'
                                +   item.noitem+' '+item.nmitem
                                + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.noitem+' '+item.nmitem
                                + '</option>';
                    }                    
                }
            })
            $('#tbh_entry_'+type).empty().append(options);
        }

        //Inline editor tabel entry
        var state_active_editor_entry = false;
        var editor_entry;
        var active_entry;
        tabel_riwayat.on('dblclick', 'tr td', function () {
            active_entry = $(this);
            if({{#unless admin}}active_entry.closest('tr').find('td:eq(8)').text()!= user_aktiv || {{/unless}}state_active_editor_entry || active_entry.is(':nth-child(1)') || active_entry.is(':nth-child(2)') || active_entry.is(':nth-child(13)') || active_entry.is(':nth-child(14)')){
                {{#unless admin}}
                if(active_entry.closest('tr').find('td:eq(8)').text()!= user_aktiv){
                    $.toast({
                        text: 'Maaf Anda tidak dapat mengedit entrian pengguna lain.',
                        textAlign: 'left', 
                        hideAfter: 1000,
                        loader: false,
                        position: 'bottom-right',
                        allowToastClose: false
                    })
                    return;
                }
                {{/unless}}
                $.toast({
                    text: 'Anda tidak dapat mengedit sel tersebut.',
                    textAlign: 'left', 
                    hideAfter: 1000,
                    loader: false,
                    position: 'bottom-right',
                    allowToastClose: false
                })
                return;
            }
            state_active_editor_entry = true;
            var cloneProperties = ['padding', 'padding-top', 'padding-bottom', 'padding-left', 'padding-right',
                          'text-align', 'font', 'font-size', 'font-family', 'font-weight',
                          'border', 'border-top', 'border-bottom', 'border-left', 'border-right'];
            if(active_entry.hasClass('format-uang')){
                editor_entry = $('<input type="text" class="format-uang">').val(getNumber(active_entry.text())).hide().appendTo(active_entry.parent());
            } else if(active_entry.is(':nth-child(3)')) {
                editor_entry = $('<input type="text" class="date">').val(active_entry.text()).hide().appendTo(active_entry.parent());
                editor_entry.datetimepicker({
                    locale: 'id',
                    format: 'D MMMM YYYY',
                    useCurrent: false //Important! See issue #1075
                });
            }  else if(active_entry.is(':nth-child(4)')) {
                editor_entry = $('<input type="text" class="penerima-autocomplete">').val(active_entry.text()).hide().appendTo(active_entry.parent());
                editor_entry.typeahead({
                        hint: true,
                        highlight: true,
                        minLength: 1
                    }, {
                        source: function(q, p){
                                {
                                    socket.emit('penerima_list', q, function (data) {
                                        return p(_.map(data, function(peg){ return {_id: peg._id, value: peg.nama}}))
                                    });
                                }
                        }
                    }
                );
                active_entry.css('visibility','hidden');
            } else {
                editor_entry = $('<textarea></textarea>').val(active_entry.text()).hide().appendTo(active_entry.parent());
            }

            editor_entry.css('position', 'absolute');
            editor_entry
                .show()
                .offset(active_entry.offset())
                .css(active_entry.css(cloneProperties))
                .width(active_entry.width())
                .height(active_entry.height())
                .focus();
            editor_entry.select();
        });

        var date_field_timestamp_temp; //temp nilai timestamp tgl utk edit riwayat
        tabel_riwayat.on('dp.change', '.date', function(e){
            date_field_timestamp_temp = e.date.unix();
        });

        var penerima_id_temp;
        tabel_riwayat.on("typeahead:selected typeahead:autocompleted", ".penerima-autocomplete", function(e,datum) {
             penerima_id_temp = datum._id;
        });

        tabel_riwayat.on('blur keydown', 'input,textarea', function (e) {
            if(!active_entry){
                return;
            }
            //jika enter anggap blur (krn klo tidak, di fired 2 kali)
            if (e.which === 13){
                $(this).blur();
                active_entry.css('visibility','visible');
            } else if (e.which === 0 && active_entry){//jika blur ==> keycode nya 0
                //jika berasal dari tombol tambah itemif(active){
                    active_entry.css('visibility','visible');

                if(editor_entry.val() !== active_entry.text()){
                    if(editor_entry.val() == ''){
                        editor_entry.val('-');
                    }
                    var new_value = editor_entry.val();
                    var active_entry_temp = active_entry;
                    var row = tabel_riwayat.DataTable().row(active_entry.closest('tr'));
                    var parent_id = $("#tbh_entry_detail").val();
                    var data = {};
                    if(active_entry.is(':nth-child(3)')){
                        if(new_value == '-' || new_value == '' || !date_field_timestamp_temp){
                            active_entry = null;
                            state_active_editor_entry = false;
                            editor_entry.hide();
                            return;
                        }
                        data = {'realisasi.$.tgl': new_value, 'realisasi.$.tgl_timestamp': date_field_timestamp_temp}
                    } else if(active_entry.is(':nth-child(4)')){
                        active_entry.css('visibility','visible');
                        if(new_value == '-' || new_value == ''){
                            active_entry = null;
                            state_active_editor_entry = false;
                            editor_entry.hide();
                            return;
                        }
                        data = {'realisasi.$.penerima_nama': new_value, 'realisasi.$.penerima_id': penerima_id_temp}
                        penerima_id_temp = null;
                    } else if(active_entry.is(':nth-child(5)')){
                        if(new_value == '-' || new_value == ''|| new_value == '0'){
                            active_entry = null;
                            state_active_editor_entry = false;
                            editor_entry.hide();
                            return;
                        }
                        data = {'realisasi.$.jumlah': getNumber(new_value)}
                    }  else if(active_entry.is(':nth-child(6)')){
                        if(new_value == '-' || new_value == ''|| new_value == '0'){
                            active_entry = null;
                            state_active_editor_entry = false;
                            editor_entry.hide();
                            return;
                        }
                        data = {'realisasi.$.pph21': getNumber(new_value)}
                    }  else if(active_entry.is(':nth-child(7)')){
                        if(new_value == '-' || new_value == ''|| new_value == '0'){
                            active_entry = null;
                            state_active_editor_entry = false;
                            editor_entry.hide();
                            return;
                        }
                        data = {'realisasi.$.pph22': getNumber(new_value)}
                    }  else if(active_entry.is(':nth-child(8)')){
                        if(new_value == '-' || new_value == ''|| new_value == '0'){
                            active_entry = null;
                            state_active_editor_entry = false;
                            editor_entry.hide();
                            return;
                        }
                        data = {'realisasi.$.pph23': getNumber(new_value)}
                    }  else if(active_entry.is(':nth-child(9)')){
                        if(new_value == '-' || new_value == ''|| new_value == '0'){
                            active_entry = null;
                            state_active_editor_entry = false;
                            editor_entry.hide();
                            return;
                        }
                        data = {'realisasi.$.ppn': getNumber(new_value)}
                    } else if(active_entry.is(':nth-child(10)')){
                        data = {'realisasi.$.spm_no': new_value}
                    } else if(active_entry.is(':nth-child(11)')){
                        data = {'realisasi.$.bukti_no': new_value}
                    } else if(active_entry.is(':nth-child(12)')){
                        data = {'realisasi.$.ket': new_value}
                    }
                    data['realisasi.$.timestamp'] = Math.round(new Date().getTime()/1000);
                    socket.emit('riwayat_edit', {'parent_id': parent_id, 'target_id': row.data()[0], 'data': data}, function(status){
                            if(status === 'sukses'){
                                tabel_riwayat.DataTable()
                                    .cell(active_entry_temp)
                                    .data(new_value)
                                    .draw(false);
                                generalAlert('Berhasil diedit.');
                            }
                    });                    
                }
                active_entry = null;
                state_active_editor_entry = false;
                editor_entry.hide();
            } else if(e.which === 27){
                active_entry.css('visibility','visible');
                active_entry = null;
                state_active_editor_entry = false;
                editor_entry.hide();
            }
        });

        var parent_id;
        var target_id;
        var temp;
        var row;
        var target_delete;
        var state_undo;
        tabel_riwayat.on('click', '.del-riwayat-tbl', function (e) {
            //cek jk ada yg dihapus sebelumnya
            if(target_delete){
                $.toast().reset('all');
                //jika ada, hapus target delete sebelumnya
                socket.emit('del_riwayat', {'parent_id': parent_id, 'target_id': target_id, 
                    'month': $('#bulan_realisasi').val()}, function(status){});
                row.remove().draw(false);
                target_delete = null;
            }
            state_undo = false;
            {{#unless admin}}
            if($(this).closest('tr').find('td:eq(8)').text()!= user_aktiv){
                generalAlert('Maaf, Anda tidak memiliki hak akses.')
                return;
            }
            {{/unless}}
            target_delete = $(this).closest('tr');
            row = tabel_riwayat.DataTable().row(target_delete);
            target_id = row.data()[0];
            target_delete.hide();
            parent_id = $("#tbh_entry_detail").val();
            $.toast({
                text: 'Terhapus | <a id="undo_delete" href="#"><i class="fa fa-undo fa-sm"></i> Batal</a>',
                textAlign: 'right', 
                hideAfter: 4000,
                loader: false,
                stack: false,
                position: 'bottom-right',
                allowToastClose: false,
                afterHidden: function () {
                    if(!state_undo){
                        socket.emit('del_riwayat', {'parent_id': parent_id, 'target_id': target_id, 
                            'month': $('#bulan_realisasi').val()}, function(status){
                            if(status === 'sukses'){
                                $(this).html(temp);
                                row.remove().draw(false);
                            } else {
                                $(this).html(temp);
                            }
                        });
                        target_delete = null;
                    }
                }
            })
            $('#undo_delete').click(function(){
                state_undo = true;
                target_delete.show();
                target_delete = null;
                $.toast().reset('all');
            })
        })
        
        //datatable
        var dt = $('#pok_table_entry').DataTable();

        socket.on('pok_entry_update_realisasi', function(data) {

            //row umum sbg target
            var target_row = $('#pok_table_entry').DataTable()
                            .rows(function ( idx, dataa, node ) {
                                return dataa[0] == data.parent_id ?
                                    true : false;})
                            .nodes()
                            .to$();

            if(target_row.length == 0) return;

            //init nilai pengeluaran
            var new_value = 0;
            //init nilai total sampai bulan ini
            var new_tsbi = 0;
            //init nilai realisasi bln lalu
            var new_rbl = 0;
            //init nilai sisa dana
            var sisa_dana = 0;

            //jika sum/ ingin diubah total
            if(data.sum){
                //nilai baru total sampai bulan ini
                new_tsbi = data.total_sampai_bln_ini;

                //nilai baru pengeluaran
                new_value = data.realisasi;

                //nilai baru realisasi bln lalu
                new_rbl = +new_tsbi - +new_value;

                //nilai baru sisa dana
                sisa_dana = getNumber(target_row.find('td:eq(6)').text())-new_tsbi;

                //update dt
                dt
                .cell(target_row.find('td:eq(9)'))
                .data(new_tsbi)
                .cell(target_row.find('td:eq(7)'))
                .data(new_value)
                .cell(target_row.find('td:eq(8)'))
                .data(new_rbl)
                .cell(target_row.find('td:eq(10)'))
                .data((getNumber(new_tsbi)/getNumber(target_row.find('td:eq(6)').text())*100).toFixed(0)+'%')
                .cell(target_row.find('td:eq(11)'))
                .data(sisa_dana);

                //update parent
                updateParentRealisasi(target_row.find('td:eq(7)'), 0, new_value, 0, new_tsbi)
            } 
            //jika ada tambahan entry
            else {
                //jika entry baru di atas bulan terpilih, tdk perlu tambah
                //nilai baru total sampai bulan ini
                new_tsbi = getNumber(target_row.find('td:eq(9)').text()) + getNumber(data.total_sampai_bln_ini || 0);

                //nilai baru pengeluaran
                new_value = getNumber(target_row.find('td:eq(7)').text()) + getNumber(data.realisasi || 0);

                //nilai baru realisasi bln lalu
                new_rbl = +new_tsbi - +new_value;

                //nilai baru sisa dana
                sisa_dana = getNumber(target_row.find('td:eq(6)').text())-new_tsbi;

                //update parent
                updateParentRealisasi(target_row.find('td:eq(7)'), getNumber(target_row.find('td:eq(7)').text()), new_value, 
                    getNumber(target_row.find('td:eq(9)').text()), new_tsbi)

                //update dt pengeluaran
                dt
                .cell(target_row.find('td:eq(9)'))
                .data(new_tsbi)
                .cell(target_row.find('td:eq(7)'))
                .data(new_value)
                .cell(target_row.find('td:eq(8)'))
                .data(new_rbl)
                .cell(target_row.find('td:eq(10)'))
                .data((new_tsbi/getNumber(target_row.find('td:eq(6)').text())*100).toFixed(0)+'%')
                .cell(target_row.find('td:eq(11)'))
                .data(sisa_dana);
            } 

            // tampilan format uang pengeluaran
            // setAutoNumeric(target_row.find('td:eq(9)'), new_tsbi);
            // setAutoNumeric(target_row.find('td:eq(8)'), new_rbl);
            // setAutoNumeric(target_row.find('td:eq(7)'), new_value);
            // setAutoNumeric(target_row.find('td:eq(11)'), sisa_dana);
            target_row.find('td:eq(9)').text(formatUang(new_tsbi));
            target_row.find('td:eq(8)').text(formatUang(new_rbl));
            target_row.find('td:eq(7)').text(formatUang(new_value));
            target_row.find('td:eq(11)').text(formatUang(sisa_dana));

            if(getNumber(sisa_dana) < 0){
                target_row.find('td:eq(11)').css("background-color", "yellow")
            } else {
                target_row.find('td:eq(11)').css("background-color", "")
            }
            if(data.broadcast){
                if(data.message) generalAlert(data.message)
                    else generalAlert('1 realisasi baru telah ditambahkan.')
            }
        });

        function updateParentRealisasi(child_td_element, old_child_price, new_child_price, old_child_dtsbi_price, new_child_dtsbi_price){
            //ambil id parent
            if(_.isUndefined(child_td_element.closest('tr').data())) return;
            var parent_id = $('#pok_table_entry').DataTable().row(child_td_element.closest('tr')).data()[1];

            //ambil row parent
            var prt_row = $('#pok_table_entry').DataTable()
                                .rows( function ( idx, data, node ) {
                                    return data[0] == parent_id ?
                                        true : false;
                                } );

            if(_.isUndefined(prt_row.data()[0])) return; //jika parent row undefine, berarti sdh dihapus ==> tdk perlu update jumlah parent 

            //ambil parent td
            var parent_pengeluaran_td = prt_row
                                    .nodes()
                                    .to$()

            var old_jlh = getNumber(prt_row.data()[0][9]);

            var old_jlh_tsbi = getNumber(prt_row.data()[0][11]);

            var new_jumlah = old_jlh - old_child_price + new_child_price;

            var new_jumlah_tsbi = old_jlh_tsbi - old_child_dtsbi_price + new_child_dtsbi_price;

            var new_rsbl = +new_jumlah_tsbi - +new_jumlah;

            var sisa_dana = getNumber(parent_pengeluaran_td.find('td:eq(6)').text()) - new_jumlah_tsbi

            $('#pok_table_entry').DataTable()
                .cell(parent_pengeluaran_td.find('td:eq(9)'))
                .data(new_jumlah_tsbi)
                .cell(parent_pengeluaran_td.find('td:eq(7)'))
                .data(new_jumlah)
                .cell(parent_pengeluaran_td.find('td:eq(8)'))
                .data(new_rsbl)
                .cell(parent_pengeluaran_td.find('td:eq(10)'))
                .data((getNumber(new_jumlah_tsbi)/getNumber(parent_pengeluaran_td.find('td:eq(6)').text())*100).toFixed(0)+'%')
                .cell(parent_pengeluaran_td.find('td:eq(11)'))
                .data(sisa_dana)

            //tampilan
            // setAutoNumeric(parent_pengeluaran_td.find('td:eq(9)'), new_jumlah_tsbi);
            // setAutoNumeric(parent_pengeluaran_td.find('td:eq(7)'), new_jumlah);
            // setAutoNumeric(parent_pengeluaran_td.find('td:eq(8)'), new_rsbl);
            // setAutoNumeric(parent_pengeluaran_td.find('td:eq(11)'), sisa_dana);

            parent_pengeluaran_td.find('td:eq(9)').text(formatUang(new_jumlah_tsbi));
            parent_pengeluaran_td.find('td:eq(8)').text(formatUang(new_rsbl));
            parent_pengeluaran_td.find('td:eq(7)').text(formatUang(new_jumlah));
            parent_pengeluaran_td.find('td:eq(11)').text(formatUang(sisa_dana));

            if(getNumber(sisa_dana) < 0){
                parent_pengeluaran_td.find('td:eq(11)').css("background-color", "yellow")
            } else {
                parent_pengeluaran_td.find('td:eq(11)').css("background-color", "")
            }

            var type = parent_pengeluaran_td.closest('tr').find('span').html();
            if(type != 'program'){
                updateParentRealisasi(parent_pengeluaran_td, old_jlh, new_jumlah, old_jlh_tsbi, new_jumlah_tsbi);
            } else {
                var prt_row = $('#pok_table_entry').DataTable()
                        .rows( function ( idx, data, node ) {
                            return data[2] == '<span class="badge badge-default">program</span>' ?
                                true : false;
                        } );

                var realisasi_bulan_ini = 0;
                var realisasi_bulan_lalu = 0;
                var sampai_bln_ini = 0;
                var sisa_dana = 0;

                var pagu = 0;

                _.each(prt_row.data(), function(program, index, list){
                    realisasi_bulan_ini += getNumber(program[9]);
                    realisasi_bulan_lalu += getNumber(program[10]);
                    sampai_bln_ini += getNumber(program[11]);
                    sisa_dana += getNumber((getNumber(program[13]) == 0)?program[8]:program[13]);

                    pagu += getNumber(program[8]);
                })

                $('#realisasi-bulan-ini').html(formatUang(realisasi_bulan_ini).replace(/\-$/g,''));
                $('#realisasi-bulan-ini-percent').html(' ('+((getNumber(realisasi_bulan_ini)/pagu)*100).toFixed(2)+'%)');

                $('#realisasi-bulan-lalu').html(formatUang(realisasi_bulan_lalu).replace(/\-$/g,''));
                $('#realisasi-bulan-lalu-percent').html(' ('+((getNumber(realisasi_bulan_lalu)/pagu)*100).toFixed(2)+'%)');

                $('#sampai-bln-ini').html(formatUang(sampai_bln_ini).replace(/\-$/g,''));
                $('#sampai-bln-ini-percent').html(' ('+((getNumber(sampai_bln_ini)/pagu)*100).toFixed(2)+'%)');

                $('#sisa-dana').html(formatUang(sisa_dana).replace(/\-$/g,''));
                $('#sisa-dana-percent').html(' ('+((getNumber(sisa_dana)/pagu)*100).toFixed(2)+'%)');
                // adjustColumn()
            }
        }

        function adjustColumn(){
            var table = $.fn.dataTable.fnTables(true);
            if ( table.length > 0 ) {
                $(table).dataTable().fnAdjustColumnSizing();
            }
        }


        //////////EDIT
        //search & sort
        //tabel pok edit
        $('#pok_table_edit').DataTable({
            //scrollY:        "500px",
            //scrollX:        true,
            //scrollCollapse: true,
            //fixedColumns: true,
            columnDefs: [
                {
                    "targets": [ 0, 1 ],
                    "visible": false,
                    "searchable": false
                }
            ],
            aaSorting: [],
            rowReorder: {
                enable: false
            },
            paging: false,
            createdRow: function( row, data, dataIndex ) {
                if(/^054/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level0');
                } else if(/^\d{4}$/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level1');
                } else if(/^\d{4}\./.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level2');
                } else if(/^\d{3}\.\d{3}$/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level3');
                } else if(/^\d{3}$/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level4');
                } else if(/[A-Z]/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level5');
                } else if(/^\d{6}/.test(data[3])){
                    $( row ).find('td:eq(1)').attr('class', 'level6');
                } else {
                    $( row ).find('td:eq(1)').attr('class', 'level6');
                }
                $( row ).find('td:eq(3)').attr('class','format-uang');
                $( row ).find('td:eq(4)').attr('class', 'satuan-unit');
                $( row ).find('td:eq(5)').attr('class', 'format-uang');
                $( row ).find('td:eq(6)').attr('class', 'format-uang');
                $( row ).find('td:eq(7)').attr('class', 'text-center');
            }
        });

        //POK Title edit
        $('#pok_title').hide();
        $('.edit').click(function(){
            $(this).hide();
            $(this).prev().hide();
            $(this).next().show();
            $(this).next().select();
        });
        $('#pok_title').blur(function() {
             if ($.trim(this.value) == ''){
                 this.value = (this.defaultValue ? this.defaultValue : '');
             }
             else{
                if(this.value != $(this).prev().prev().html()){
                    $('.pok-title').text(this.value);
                    socket.emit('pok_title_submit', this.value);
                }
             }
     
             $(this).hide();
             $(this).prev().show();
             $(this).prev().prev().show();
        });
        $('#pok_title').keypress(function(event) {
              if (event.keyCode == '13') {
                  if ($.trim(this.value) == ''){
                     this.value = (this.defaultValue ? this.defaultValue : '');
                 }
                 else
                 {
                    $('.pok-title').text(this.value);
                    socket.emit('pok_title_submit', this.value);
                 }

                 $(this).hide();
                 $(this).prev().show();
                 $(this).prev().prev().show();
              }
        });

        //Tombol buka modal edit uraian
        $('#btn-edit-uraian-akun').click(function () {
            //ambil data
            socket.emit('pok_uraian_akun_get');
            //tampilkan modal
            $('#edit-uraian-akun').modal('show');
        })
        $('#edit-uraian-akun').on('shown.bs.modal', function () {
            //fokus ke field 1st
          $('#eua_kode_akun').focus();
        });
        $('#btn-tambah-uraian-akun').click(function () {
            var _id = $('#eua_kode_akun').val()
            var uraian = $('#eua_uraian_akun').val();
            if(_id == '' || uraian == ''){
                generalAlert('Isian tidak boleh kosong.');
                return;
            }
            socket.emit('pok_uraian_akun_entry', {'_id': _id.replace(/\s/g, ''), 'uraian': uraian});
            $('#eua_kode_akun').val('');
            $('#eua_uraian_akun').val('');
        });

        $('#eua_kode_akun, #eua_uraian_akun').keyup(function(e){
            if(e.keyCode == 13){
                $('#btn-tambah-uraian-akun').click();
            }
        });

        socket.on('pok_uraian_akun_get_response', function(uraianakuns) {
            var show =  '';
            $("#tbl_eua tbody").append(show);
            _.each(uraianakuns, function(uraianakun, index, list){
                show +=  '<tr id="'+uraianakun._id+'">'
                        +    '<td>'+uraianakun._id+'</td>'
                        +    '<td>'+uraianakun.uraian+'</td>'
                        +    '<td class="edit-disabled text-center"><button type="button" class="btn-del-uraian-akun"><i class="icon-close"></i></button></td>'
                        +'</tr>' 
            });
            $("#tbl_eua tbody").html(show);
        });

        socket.on('pok_uraian_akun_entry_saved_response', function(data) {
            var show =  '<tr id="'+data._id+'">'
                        +    '<td>'+data._id+'</td>'
                        +    '<td>'+data.uraian+'</td>'
                        +    '<td class="edit-disabled text-center"><button type="button" class="btn-del-uraian-akun"><i class="icon-close"></i></button></td>'
                        +'</tr>' 
            $("#tbl_eua tbody").append(show);
        });
        socket.on('pok_uraian_akun_entry_updated_response', function(data) {
            $("#"+data._id).find('td:eq(1)').text(data.uraian);
        });

        socket.on('pok_id_update_uraian_akun', function(dataa) {
            if(dataa.akuns.length == 1){
                var row_affected = $('#pok_table_edit').DataTable()
                                    .rows( function ( idx, data, node ) {
                                        return data[0] == dataa.akuns[0]._id ?
                                            true : false;
                                    } );
                if(row_affected[0].length == 0) return;

                var uraian_td = row_affected
                                        .nodes()
                                        .to$()
                                        .find('td:eq(2)');

                $('#pok_table_edit').DataTable()
                    .cell(uraian_td)
                    .data(dataa.uraian)
                    .draw(false);
            } else {
                _.each(dataa.akuns, function(element, index, list){
                    var row_affected = $('#pok_table_edit').DataTable()
                                        .rows( function ( idx, data, node ) {
                                            return data[0] == element._id ?
                                                true : false;
                                        } );
                    if(row_affected[0].length == 0) return;

                    var uraian_td = row_affected
                                            .nodes()
                                            .to$()
                                            .find('td:eq(2)');

                    $('#pok_table_edit').DataTable()
                        .cell(uraian_td)
                        .data(dataa.uraian)
                        .draw(false);
                });
            }
        });

        $("#tbl_eua").on('click', '.btn-del-uraian-akun', function () {
            socket.emit('pok_uraian_akun_remove', $(this).closest('tr').find('td:eq(0)').text());
        })
        socket.on('pok_uraian_akun_remove_response', function(id) {
             $("#"+id).remove();
        });

        //tambah item (cara 1)
        var state_selected_type = '';
        $('#jenis_item').change(function(){
            var selected = $(this).val();
            var submit = '<div class="row"><button id="form_tbh_pok_submit" type="submit">Tambah</button></div>';
            var kode = '<div class="form-group row"><label class="col-md-3 form-control-label no-left-padding" for="tbh_kode">Kode</label><div class="col-md-9"><input id="tbh_kode" name="tbh_kode" type="text" class="form-control" required/></div></div>';
            var uraian = '<div class="form-group row"><label class="col-md-3 form-control-label no-left-padding" for="tbh_uraian">Uraian</label><div class="col-md-9"><input id="tbh_uraian" name="tbh_uraian" type="text" class="form-control" required/></div></div>';
            var vol = '<div class="form-group row"><label class="col-md-3 form-control-label no-left-padding" for="tbh_vol">Volume</label><div class="col-md-9"><input id="tbh_vol" name="tbh_vol" type="text" class="form-control" required/></div></div>';
            var sat = '<div class="form-group row"><label class="col-md-3 form-control-label no-left-padding" for="tbh_sat">Satuan</label><div class="col-md-9"><input id="tbh_sat" name="tbh_sat" type="text" class="form-control" required/></div></div>';
            var hrg_satuan = '<div class="form-group row"><label class="col-md-3 form-control-label no-left-padding" for="tbh_hrg_satuan">Harga Satuan</label><div class="col-md-9"><input id="tbh_hrg_satuan" name="tbh_hrg_satuan" type="text" class="form-control format-uang" required/></div></div>';
            var jlh = '<div class="form-group row"><label class="col-md-3 form-control-label no-left-padding" for="tbh_jlh">Jumlah</label><div class="col-md-9"><input id="tbh_jlh" name="tbh_jlh" type="text" class="form-control format-uang" required/></div></div>';
            
            var prog = '<div class="form-group row"> <label class="col-md-3 form-control-label no-left-padding">Program</label> <div class="col-md-9"> <select id="tbh_program" name="tbh_program" class="form-control pok-dropdown" size="1"></select> </div> </div>';
            var keg = '<div class="form-group row"> <label class="col-md-3 form-control-label no-left-padding" for="tbh_kegiatan">Kegiatan</label> <div class="col-md-9"> <select id="tbh_kegiatan" name="tbh_kegiatan" class="form-control pok-dropdown" size="1"></select> </div> </div>';
            var outp = '<div class="form-group row"> <label class="col-md-3 form-control-label no-left-padding" for="tbh_output">Output</label> <div class="col-md-9"> <select id="tbh_output" name="tbh_output" class="form-control pok-dropdown" size="1"></select> </div> </div>';
            var s_outp = '<div class="form-group row"> <label class="col-md-3 form-control-label no-left-padding" for="tbh_s_output">Sub Output</label> <div class="col-md-9"> <select id="tbh_soutput" name="tbh_s_output" class="form-control pok-dropdown" size="1"></select> </div> </div>';
            var komp = '<div class="form-group row"> <label class="col-md-3 form-control-label no-left-padding" for="tbh_komponen">Komponen</label> <div class="col-md-9"> <select id="tbh_komponen" name="tbh_komponen" class="form-control pok-dropdown" size="1"></select> </div> </div>';
            var s_komp = '<div class="form-group row"> <label class="col-md-3 form-control-label no-left-padding" for="tbh_s_komponen">Sub Komponen</label> <div class="col-md-9"> <select id="tbh_skomponen" name="tbh_s_komponen" class="form-control pok-dropdown" size="1"></select> </div> </div>';
            var akun = '<div class="form-group row"> <label class="col-md-3 form-control-label no-left-padding" for="tbh_akun">Akun</label> <div class="col-md-9"> <select id="tbh_akun" name="tbh_akun" class="form-control pok-dropdown" size="1"></select> </div> </div>';

            var show = '';
            state_selected_type = selected;
            
            if(selected == 'program'){
                show = kode+uraian;
            } else if(selected == 'kegiatan'){
                show = prog+kode+uraian;
            } else if(selected == 'output'){
                show = prog+keg+kode+uraian;
            } else if(selected == 'soutput'){
                show = prog+keg+outp+kode+uraian;
            } else if(selected == 'komponen'){
                show = prog+keg+outp+s_outp+kode+uraian;
            } else if(selected == 'skomponen'){
                show = prog+keg+outp+s_outp+komp+kode+uraian;
            } else if(selected == 'akun'){
                show = prog+keg+outp+s_outp+komp+s_komp+kode+uraian;
            } else if(selected == 'detail'){
                show = prog+keg+outp+s_outp+komp+s_komp+akun+uraian+vol+sat+hrg_satuan+jlh;
            } else {
                form_tbh_pok.html('');
                return;
            }

            form_tbh_pok.html(show+submit);
            if(selected != 'program') socket.emit('pok_list', {'type': '', 'syarat': {}, 'sortby': 'kdprogram'});
            $('#tbh_kode').focus();
        });

        form_tbh_pok.on('keyup', '#tbh_vol, #tbh_hrg_satuan', function(){
            $('#tbh_jlh').autoNumeric('init', {digitGroupSeparator: ',', decimalCharacter: '.', decimalPlacesOverride: '0'});
            setAutoNumeric($('#tbh_jlh'), getNumber($('#tbh_vol').val()) * getNumber($('#tbh_hrg_satuan').val()))
        })

        var dropdown_selected = {};
        var parent_id_cara1 = '';
        var parent_type_cara1 = '';
        form_tbh_pok.on('change', '.pok-dropdown', function(){
            var type = $(this).attr('id').match(/tbh_(.*)/)[1];

            var kode;
            if(!$("#tbh_"+type+" option:selected").text().match(/\s?\w+(?=\s)/)) return;
            if(type != 'skomponen') kode = $("#tbh_"+type+" option:selected").text().match(/\d+(?=\s)/)[0]
                else kode = $("#tbh_"+type+" option:selected").text().match(/\s?\w+(?=\s)/)[0]
            var syarat = {};
            var sortby;

            if(type == 'program'){
                syarat.kdprogram = kode;
                sortby = 'kdgiat';
            } else if(type == 'kegiatan'){
                syarat.kdprogram = $("#tbh_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = kode;
                sortby = 'kdoutput';
            } else if(type == 'output'){
                syarat.kdprogram = $("#tbh_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = kode;
                sortby = 'kdsoutput';
            } else if(type == 'soutput'){
                syarat.kdprogram = $("#tbh_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#tbh_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = kode;
                sortby = 'kdkmpnen';
            } else if(type == 'komponen'){
                syarat.kdprogram = $("#tbh_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#tbh_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = $("#tbh_soutput option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdkmpnen = kode;
                sortby = 'kdskmpnen';
            } else if(type == 'skomponen'){
                syarat.kdprogram = $("#tbh_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#tbh_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = $("#tbh_soutput option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdkmpnen = $("#tbh_komponen option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdskmpnen = kode;
                sortby = 'kdakun';
            } else if(type == 'akun'){
                syarat.kdprogram = $("#tbh_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#tbh_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#tbh_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = $("#tbh_soutput option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdkmpnen = $("#tbh_komponen option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdskmpnen = $("#tbh_skomponen option:selected").text().match(/\s?\w+(?=\s)/)[0];
                syarat.kdakun = kode
                sortby = 'noitem'
            }
            
            socket.emit('pok_list', {'type': type, 'syarat': syarat, 'sortby': sortby});

        })
        socket.on('pok_list_response', function(data) {
            parent_id_cara1 = data.parent_id;
            parent_type_cara1 = data.parent_type;
            if(data.type == 'detail') return;
            var options ='<option value="none" selected="selected">'
                        +   '--pilih--'
                        +'</option>';
            _.each(data.items, function(item, index, list){
                if(data.type == 'program'){
                    options +='<option value="'+item._id+'">'
                            +   item.kdprogram+' '+item.uraian
                            + '</option>';
                } else if(data.type == 'kegiatan'){
                    options +='<option value="'+item._id+'">'
                            +   item.kdgiat+' '+item.uraian
                            + '</option>';
                } else if(data.type == 'output'){
                    options +='<option value="'+item._id+'">'
                            +   item.kdoutput+' '+item.uraian
                            + '</option>';
                } else if(data.type == 'soutput'){
                    options +='<option value="'+item._id+'">'
                            +   item.kdsoutput+' '+item.ursoutput
                            + '</option>';
                } else if(data.type == 'komponen'){
                    options +='<option value="'+item._id+'">'
                            +   item.kdkmpnen+' '+item.urkmpnen
                            + '</option>';
                } else if(data.type == 'skomponen'){
                    options +='<option value="'+item._id+'">'
                            +   item.kdskmpnen+' '+item.urskmpnen
                            + '</option>';
                } else if(data.type == 'akun'){
                    options +='<option value="'+item._id+'">'
                            +   item.kdakun+' '+item.uraian
                            + '</option>';
                }
            })
            $('#tbh_'+data.type).empty().append(options);
        })

        //submit
        form_tbh_pok.on('submit', function(e) {
            e.preventDefault();
            var type = $('#jenis_item').val();

            var data = {};
            data.type = type;
            data.parent_id = parent_id_cara1;
            data.parent_type = parent_type_cara1;
            if(type == 'detail'){
                if($('#tbh_program').val() == 'none' || $('#tbh_kegiatan').val() == 'none' || $('#tbh_output').val() == 'none' ||
                    $('#tbh_soutput').val() == 'none' || $('#tbh_komponen').val() == 'none' || $('#tbh_skomponen').val() == 'none' ||
                    $('#tbh_akun').val() == 'none'){
                    generalAlert('Ada level di atas yang belum dipilih.')
                    return false;
                }
                data.nmitem = $('#tbh_uraian').val()
                data.volkeg = getNumber($('#tbh_vol').val())
                data.satkeg = $('#tbh_sat').val()
                data.hargasat = getNumber($('#tbh_hrg_satuan').val());
                data.jumlah = data.volkeg * data.hargasat

                var childs_row = $('#pok_table_edit').DataTable()
                            .rows( function ( idx, data, node ) {
                                return data[1] == parent_id_cara1 ?
                                    true : false;
                            } )
                            .nodes()
                            .to$();

                data.noitem = childs_row.length;
            } else if(type == 'program'){
                //validasi
                if($('#tbh_kode').val().match)

                data.kdprogram = $('#tbh_kode').val()
                data.uraian = $('#tbh_uraian').val()
            } else if(type == 'kegiatan'){
                if($('#tbh_program').val() == 'none'){
                    generalAlert('Harap pilih program.')
                    return false;
                }
                data.kdgiat = $('#tbh_kode').val()
                data.uraian = $('#tbh_uraian').val()
            } else if(type == 'output'){
                if($('#tbh_program').val() == 'none' || $('#tbh_kegiatan').val() == 'none'){
                    generalAlert('Ada level di atas yang belum dipilih.')
                    return false;
                }
                data.kdoutput = $('#tbh_kode').val()
                data.uraian = $('#tbh_uraian').val()
            } else if(type == 'soutput'){
                if($('#tbh_program').val() == 'none' || $('#tbh_kegiatan').val() == 'none' || $('#tbh_output').val() == 'none'){
                    generalAlert('Ada level di atas yang belum dipilih.')
                    return false;
                }
                data.kdsoutput = $('#tbh_kode').val()
                data.ursoutput = $('#tbh_uraian').val()
            } else if(type == 'komponen'){
                if($('#tbh_program').val() == 'none' || $('#tbh_kegiatan').val() == 'none' || $('#tbh_output').val() == 'none' ||
                    $('#tbh_soutput').val() == 'none'){
                    generalAlert('Ada level di atas yang belum dipilih.')
                    return false;
                }
                data.kdkmpnen = $('#tbh_kode').val()
                data.urkmpnen = $('#tbh_uraian').val()
            } else if(type == 'skomponen'){
                if($('#tbh_program').val() == 'none' || $('#tbh_kegiatan').val() == 'none' || $('#tbh_output').val() == 'none' ||
                    $('#tbh_soutput').val() == 'none' || $('#tbh_komponen').val() == 'none'){
                    generalAlert('Ada level di atas yang belum dipilih.')
                    return false;
                }
                data.kdskmpnen = $('#tbh_kode').val()
                data.urskmpnen = $('#tbh_uraian').val()
            }  else if(type == 'akun'){
                if($('#tbh_program').val() == 'none' || $('#tbh_kegiatan').val() == 'none' || $('#tbh_output').val() == 'none' ||
                    $('#tbh_soutput').val() == 'none' || $('#tbh_komponen').val() == 'none' || $('#tbh_skomponen').val() == 'none'){
                    generalAlert('Ada level di atas yang belum dipilih.')
                    return false;
                }
                data.kdakun = $('#tbh_kode').val()
                data.uraian = $('#tbh_uraian').val()
            } 

            data.from = 'cara1';

            socket.emit('pok_edit_new_item', data);
        });  

        //Tambah item (cara 2)
        state_subitem_selected = '';
        $('#pok_table_edit').on('click keyup', '.tambah', function () {
            if(row_to_delete) {
                row_to_delete.remove().draw(false);
                row_to_delete = null;
            }
            $.toast().reset('all');
            var type = $(this).closest('tr').find('span').html();
            var parent_id = $('#pok_table_edit').DataTable()
                                .row($(this).closest('tr'))
                                .data()[0]

            var badge = _.template('<span class="badge badge-<%= color %>"><%= item %></span>')
            var item_badge = {color: 'default', item: 'item'};

            state_subitem_selected = $(this).attr('subitem');
            
            if(type == 'program'){
                item_badge = {color: 'default', item: 'kegiatan'};
            } else if(type == 'kegiatan'){
                item_badge = {color: 'danger', item: 'output'};
            } else if(type == 'output'){
                if(state_subitem_selected == 'sub_output' || state_subitem_selected == 'soutput'){
                    item_badge = {color: 'danger', item: 'soutput'};
                } else{
                    item_badge = {color: 'primary', item: 'komponen'};
                }
            } else if(type == 'soutput'){
                item_badge = {color: 'primary', item: 'komponen'};
            } else if(type == 'komponen'){
                if(state_subitem_selected == 'sub_komponen' || state_subitem_selected == 'skomponen'){
                    item_badge = {color: 'primary', item: 'skomponen'};
                } else{
                    item_badge = {color: 'warning', item: 'akun'};
                }
            } else if(type == 'skomponen'){
                item_badge = {color: 'warning', item: 'akun'};
            } else if(type == 'akun'){
                item_badge = {color: 'success', item: 'detail'};
            }
            
            var table = $('#pok_table_edit').DataTable();
        
            //insert a test row
            table.row.add(['',parent_id, badge(item_badge), '', '', '', '', '', '', '<button type="button" class="simpan-baru"><i class="icon-check"></i></button> <button type="button" class="hapus-item"> <i class="icon-close"></i></button>']);
            
            //move added row to desired index (here the row we clicked on)
            var index = table.row($(this).closest('tr')).index()+1,
                rowCount = table.data().length-1,
                insertedRow = table.row(rowCount).data(),
                tempRow;

            for (var i=rowCount;i>index;i--) {
                tempRow = table.row(i-1).data();
                table.row(i).data(tempRow);
                table.row(i-1).data(insertedRow);
            }     
            //refresh the page
            $('#pok_table_edit').DataTable().draw(false);

            
            if(type == 'akun'){
                active_temp = $(this).closest('tr').next().find('td:eq(2)');
            } else {
                active_temp = $(this).closest('tr').next().find('td:eq(1)');
            }
            active_temp.dblclick();

        })
        //Lanjutan cara 2 (Simpan)
        var row_last_submit;
        $('#pok_table_edit').on('click keyup', '.simpan-baru', function () {
            var add_only = ['kegiatan','skomponen','akun', 'soutput'];
            var multiple_add = ['output','komponen'];

            var button = '';

            type = $(this).closest('tr').find('span').html();

            if(add_only.includes(type)){
                button = '<button type="button" class="tambah"><i class="icon-plus"></i></button> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
            } else if(multiple_add.includes(type)){
                if(type == 'output'){
                    button = '<span class="dropdown"><button class="dropdown-toggle" type="button" data-toggle="dropdown"><i class="icon-plus"></i><span class="caret"></span></button><ul class="dropdown-menu"><li><a subitem="soutput" class="tambah" href="#">Sub Output</a></li><li><a subitem="komponen" class="tambah" href="#">Komponen</a></li></ul></span> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
                } else if(type == 'komponen'){
                    button = '<span class="dropdown"><button class="dropdown-toggle" type="button" data-toggle="dropdown"><i class="icon-plus"></i><span class="caret"></span></button><ul class="dropdown-menu"><li><a subitem="skomponen" class="tambah" href="#">Sub Komponen</a></li><li><a subitem="akun" class="tambah" href="#">Akun</a></li></ul></span> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
                }
            } else {
                 button = '<button type="button" class="hapus-item"><i class="icon-close"></i></button>';
            }

            row_last_submit = $('#pok_table_edit').DataTable().row($(this).closest('tr'));
            var row_data = row_last_submit.data();
            var parent_row = $('#pok_table_edit').DataTable()
                        .rows( function ( idx, data, node ) {
                            return data[0] == row_data[1] ?
                                true : false;
                        } )
                        .nodes()
                        .to$();

            var data = {};
            data.type = type;
            data.parent_id = row_data[1];
            data.parent_type = parent_row.find('span').html();
            if(type == 'detail'){
                if(!row_data[4] || !row_data[5] || !row_data[6] || !row_data[7] || !row_data[8]){
                    generalAlert('Harap isi semua kolom (kecuali kolom yang tidak bisa diisi).');
                    return;
                }
                data.nmitem = row_data[4]
                data.volkeg = getNumber(row_data[5]);
                data.satkeg = row_data[6]
                data.hargasat = getNumber(row_data[7]);
                data.jumlah = getNumber(row_data[8]);

                var childs_row = $('#pok_table_edit').DataTable()
                            .rows( function ( idx, data, node ) {
                                return data[1] == row_data[1] ?
                                    true : false;
                            } )
                            .nodes()
                            .to$();

                data.noitem = childs_row.length;
            } else if(type == 'program'){
                if(!row_data[3].match(/^\d{2}$|\.\d{2}$/)){
                    generalAlert('Kode program tidak valid.');
                    return;
                }
                if(!row_data[4]){
                    generalAlert('Uraian wajib diisi.');
                    return;
                }
                data.kdprogram = row_data[3].match(/\d{2}$/)[0]
                data.uraian = row_data[4]
            } else if(type == 'kegiatan'){
                if(!row_data[3].match(/^\d{4}$|\.\d{4}$/)){
                    generalAlert('Kode kegiatan tidak valid.');
                    return;
                }
                if(!row_data[4]){
                    generalAlert('Uraian wajib diisi.');
                    return;
                }
                data.kdgiat = row_data[3].match(/\d{4}$/)[0]
                data.uraian = row_data[4]
            } else if(type == 'output'){
                if(!row_data[3].match(/^\d{3}$|\.\d{3}$/)){
                    generalAlert('Kode output tidak valid.');
                    return;
                }
                if(!row_data[4]){
                    generalAlert('Uraian wajib diisi.');
                    return;
                }
                data.kdoutput = row_data[3].match(/\d*$/)[0]
                data.uraian = row_data[4]
            } else if(type == 'soutput'){
                if(!row_data[3].match(/^\d{3}$|\.\d{3}$/)){
                    generalAlert('Kode sub output tidak valid.');
                    return;
                }
                if(!row_data[4]){
                    generalAlert('Uraian wajib diisi.');
                    return;
                }
                data.kdsoutput = row_data[3].match(/\d*$/)[0]
                data.ursoutput = row_data[4]
            } else if(type == 'komponen'){
                if(!row_data[3].match(/^\d{3}$|\.\d{3}$/)){
                    generalAlert('Kode komponen tidak valid.');
                    return;
                }
                if(!row_data[4]){
                    generalAlert('Uraian wajib diisi.');
                    return;
                }
                data.kdkmpnen = row_data[3].match(/\d{3}$/)[0]
                data.urkmpnen = row_data[4]
            } else if(type == 'skomponen'){
                if(!row_data[3].match(/^[A-Z]{1}$|\.[A-Z]{1}$/)){
                    generalAlert('Kode sub komponen tidak valid.');
                    return;
                }
                if(!row_data[4]){
                    generalAlert('Uraian wajib diisi.');
                    return;
                }
                data.kdskmpnen = row_data[3].match(/[A-Z]{1}$/)[0]
                data.urskmpnen = row_data[4]
            }  else if(type == 'akun'){
                if(!row_data[3].match(/^\d{6}$|\.\d{6}/)){
                    generalAlert('Kode akun tidak valid.');
                    return;
                }
                if(!row_data[4]){
                    generalAlert('Uraian wajib diisi.');
                    return;
                }
                data.kdakun = row_data[3].match(/\d{6}/)[0]
                data.uraian = row_data[4]
            } 

            var this_td = $(this).closest('td');

            socket.emit('pok_edit_new_item', data, function(status){
                if(status == 'sukses'){
                    $('#pok_table_edit').DataTable()
                    .cell(this_td)
                    .data(button)
                    .draw(false);
                }
            });
        })

        socket.on('pok_new_id', function(data) {
            if(!row_last_submit) return;
            var old_data = row_last_submit.data();
            old_data[0] = data;

            row_last_submit.data(old_data);
        })

        //hapus item/ batalkan penambahan
        var row_to_delete;
        var row_to_delete_type;
        $('#pok_table_edit').on('click', '.hapus-item', function () {
            if(row_to_delete) {
                if(row_to_delete_type != 'program'){
                    updateParentJumlah(row_to_delete.nodes().to$().find('td:eq(6)'), 
                        getNumber(row_to_delete.nodes().to$().find('td:eq(6)').text()), 0);
                }
                socket.emit('pok_delete_item', {_id: row_to_delete.data()[0], type: row_to_delete_type});
                if(row_to_delete_type != 'detail') removeChilds(row_to_delete, 'remove');
                row_to_delete.remove().draw(false);
                row_to_delete = null;
            }
            var state_undo = false;
            tabel_pok_edit_dt = tabel_pok_edit.DataTable();
            var item = $(this).parents('tr');
            row_to_delete_type = item.find('span').html();
            row_to_delete = tabel_pok_edit.DataTable().row(item);
            if(row_to_delete.data()[0]) removeChilds(row_to_delete, 'hide');
            
            item.hide();
            $.toast({
                text: 'Terhapus | <a id="undo_delete" href="#"><i class="fa fa-undo fa-sm"></i> Batal</a>',
                textAlign: 'right', 
                hideAfter: 4000,
                loader: false,
                stack: false,
                position: 'bottom-right',
                allowToastClose: false,
                afterHidden: function () {
                    if(!state_undo){
                        socket.emit('pok_delete_item', {_id: row_to_delete.data()[0], type: row_to_delete_type});
                        if(row_to_delete_type != 'program'){
                            updateParentJumlah(row_to_delete.nodes().to$().find('td:eq(6)'), 
                                getNumber(row_to_delete.nodes().to$().find('td:eq(6)').text()), 0);
                        }
                        if(row_to_delete_type != 'detail') removeChilds(row_to_delete, 'remove');
                        row_to_delete.remove().draw(false);
                        row_to_delete = null;
                    }
                }
            })
            $('#undo_delete').click(function(){
                if(row_to_delete_type != 'detail') removeChilds(row_to_delete, 'show');
                row_to_delete = null;
                state_undo = true
                item.show();
                $.toast().reset('all');
            })
        });

        function removeChilds(row_to_delete, remove){
            var row_to_delete_type = $(row_to_delete.data()[2]).text()
            if(row_to_delete_type != 'detail'){
                var childs = $('#pok_table_edit').DataTable()
                            .rows( function ( idx, data, node ) {
                                return data[1] == row_to_delete.data()[0] ?
                                    true : false;
                                });
                _.each(childs.nodes().to$(), function(child, index, list){
                    if(remove == 'hide') removeChilds(tabel_pok_edit_dt.row(child), 'hide')
                        else if(remove == 'remove') {
                            removeChilds(tabel_pok_edit_dt.row(child), 'remove');
                        }
                            else if(remove == 'show') removeChilds(tabel_pok_edit_dt.row(child), 'show');
                    if(remove == 'hide') tabel_pok_edit_dt.row(child).nodes().to$().hide()
                        else if(remove == 'remove') tabel_pok_edit_dt.row(child).remove()
                            else if(remove == 'show') tabel_pok_edit_dt.row(child).nodes().to$().show()
                });
            }
        }

        //sorting to default
        $('.default-sort-column').click(function(){
            $(this).closest('table').dataTable().fnSortNeutral();
        });
        $('.default-sort-column-entry').click(function(){
            $('#pok_table_entry').dataTable().fnSortNeutral();
        });

        //Inline editor
        var state_active_editor = false;
        var editor;
        var active;
        var active_temp;
        $('#pok_table_edit').on('dblclick', 'tr td', function () {
            active = $(this);
            var type = active.closest('tr').find('span').html();
            if(state_active_editor || active.is(':nth-child(1)') || active.is(':nth-child(7)') 
                || active.is(':nth-child(8)') || (type == 'detail' && active.is(':nth-child(2)'))
                || (type != 'detail' && (active.is(':nth-child(4)') || active.is(':nth-child(5)') || active.is(':nth-child(6)'))) ){
                $.toast({
                    text: 'Anda tidak dapat mengedit sel tersebut.',
                    textAlign: 'left', 
                    hideAfter: 1000,
                    loader: false,
                    position: 'bottom-right',
                    allowToastClose: false
                })
                return;
            }
            state_active_editor = true;
            var cloneProperties = ['padding', 'padding-top', 'padding-bottom', 'padding-left', 'padding-right',
                          'text-align', 'font', 'font-size', 'font-family', 'font-weight',
                          'border', 'border-top', 'border-bottom', 'border-left', 'border-right'];
            if(active.hasClass('format-uang')){
                editor = $('<input type="text" class="format-uang">').val(getNumber(active.text())).hide().appendTo(active.parent());
            } else if(active.hasClass('satuan-unit')) {
                getAjax("/pok/satuan_pok", function(data){
                    var datalist = '<input list="satuans" name="satuan">'
                                    +'<datalist id="satuans">'
                    _.each(data, function(element, index, list){
                        datalist += '<option value="'+element+'">';
                    });
                    datalist += '</datalist>';
                    editor = $(datalist).val(active.text()).hide().appendTo(active.parent());

                    editor.css('position', 'absolute');
                    editor
                        .show()
                        .offset(active.offset())
                        .css(active.css(cloneProperties))
                        .width(active.width())
                        .height(active.height())
                        .focus();
                    editor.select();
                });
                return;
            } else {
                editor = $('<textarea></textarea>').val(active.text()).hide().appendTo(active.parent());
            }

            editor.css('position', 'absolute');
            editor
                .show()
                .offset(active.offset())
                .css(active.css(cloneProperties))
                .width(active.width())
                .height(active.height())
                .focus();
            editor.select();
        })

        $('#pok_table_edit').on('blur keydown', 'input,textarea', function (e) {
            var type = active.closest('tr').find('span').html();
            //jika enter anggap blur (krn klo tidak, di fired 2 kali)
            if (e.which === 13){
                $(this).blur();
            } else if (e.which === 0){//jika blur ==> keycode nya 0
                //jika berasal dari tombol tambah item
                if(active_temp){
                    if(editor.val() == active_temp.text()){
                        active_temp = null;
                        active = null;
                        state_active_editor = false;
                        editor.hide();
                        return;
                    }
                    if(editor.val() == ''){
                        editor.val('-');
                    }
                    $('#pok_table_edit').DataTable()
                        .cell(active_temp)
                        .data(editor.val())
                        .draw(false);
                    //jika yg berubah kolom 4 atau 6, jumlah diupdate
                    if(active.is(':nth-child(4)')){
                        setNumberMultiply(active_temp.next().next().next(), active_temp, active_temp.next().next());
                    } else if(active.is(':nth-child(6)')){
                        setNumberMultiply(active_temp.next(), active_temp, active_temp.prev().prev());
                    }
                } else if(active){
                    if(editor.val() == active.text()){
                        active_temp = null;
                        active = null;
                        state_active_editor = false;
                        editor.hide();
                        return;
                    }
                    if(editor.val() == ''){
                        editor.val('-');
                    }
                    $('#pok_table_edit').DataTable()
                        .cell(active)
                        .data(editor.val())
                        .draw(false);
                    if(active.is(':nth-child(4)')){
                        setNumberMultiply(active.next().next().next(), active, active.next().next());
                    } else if(active.is(':nth-child(6)')){
                        setNumberMultiply(active.next(), active, active.prev().prev());
                    }
                }
                //update db
                var row_data = $('#pok_table_edit').DataTable().row(editor.closest('tr')).data();
                if(!row_data[0]){
                    active_temp = null;
                    active = null;
                    state_active_editor = false;
                    editor.hide();
                    return;
                }
                var data = {};
                data.type = type;
                data._id = row_data[0];
                if(type == 'detail'){
                    if(active.is(':nth-child(3)')){
                        data.nmitem = row_data[4]
                    }  else if(active.is(':nth-child(4)')){
                        data.volkeg = getNumber(row_data[5])
                        data.jumlah = getNumber(row_data[8])
                    }  else if(active.is(':nth-child(6)')){
                        data.hargasat = getNumber(row_data[7])
                        data.jumlah = getNumber(row_data[8])
                    }  else if(active.is(':nth-child(5)')){
                        data.satkeg = row_data[6]
                    }
                } else if(type == 'program'){
                    if(active.is(':nth-child(2)')){
                        data.kdprogram = row_data[3].match(/\d*$/)[0];
                    } else if(active.is(':nth-child(3)')){
                        data.uraian = row_data[4]
                    }                
                } else if(type == 'kegiatan'){
                    if(active.is(':nth-child(2)')){
                        data.kdgiat = row_data[3]
                    } else if(active.is(':nth-child(3)')){
                        data.uraian = row_data[4]
                    }                
                } else if(type == 'output'){
                    if(active.is(':nth-child(2)')){
                        data.kdoutput = row_data[3].match(/\d*$/)[0]
                    } else if(active.is(':nth-child(3)')){
                        data.uraian = row_data[4]
                    }                
                } else if(type == 'soutput'){
                    if(active.is(':nth-child(2)')){
                        data.kdsoutput = row_data[3].match(/\d*$/)[0]
                    } else if(active.is(':nth-child(3)')){
                        data.ursoutput = row_data[4]
                    }                
                } else if(type == 'komponen'){
                    if(active.is(':nth-child(2)')){
                        data.kdkmpnen = row_data[3]
                    } else if(active.is(':nth-child(3)')){
                        data.urkmpnen = row_data[4]
                    }                
                } else if(type == 'skomponen'){
                    if(active.is(':nth-child(2)')){
                        data.kdskmpnen = row_data[3]
                    } else if(active.is(':nth-child(3)')){
                        data.urskmpnen = row_data[4]
                    }                
                }  else if(type == 'akun'){
                    if(active.is(':nth-child(2)')){
                        data.kdakun = row_data[3]
                    } else if(active.is(':nth-child(3)')){
                        data.uraian = row_data[4]
                    }                
                } 
                socket.emit('pok_edit_item', data);
                active_temp = null;
                active = null;
                state_active_editor = false;
                editor.hide();
            } else if(e.which === 27){
                active_temp = null;
                active = null;
                state_active_editor = false;
                editor.hide();
            }
        });

        function setNumberMultiply(target, active, pair){
            // ///update akun jumlah
            var multiply_result = getNumber(active.text()) * getNumber(pair.text());

            updateParentJumlah(target, getNumber(target.html()), multiply_result);

            //update datatable jumlah
            $('#pok_table_edit').DataTable()
                .cell(target)
                .data(multiply_result)
                .draw(false);

            //update tampilan format uang jumlah
            // setAutoNumeric(target, );
            target.text(formatUang(multiply_result));
            
        }

        function updateParentJumlah(child_td_element, old_child_price, new_child_price){
            //ambil id parent
            if(_.isUndefined(child_td_element.closest('tr').data())) return;
            var parent_id = $('#pok_table_edit').DataTable().row(child_td_element.closest('tr')).data()[1];

            //ambil row parent
            var prt_row = $('#pok_table_edit').DataTable()
                                .rows( function ( idx, data, node ) {
                                    return data[0] == parent_id ?
                                        true : false;
                                } );

            if(_.isUndefined(prt_row.data()[0])) return; //jika parent row undefine, berarti sdh dihapus ==> tdk perlu update jumlah parent 

            //ambil parent td
            var parent_jumlah_td = prt_row
                                    .nodes()
                                    .to$()
                                    .find('td:eq(6)');

            var old_jlh = getNumber(prt_row.data()[0][8]);

            var new_jumlah = old_jlh - getNumber(old_child_price) + getNumber(new_child_price);

            $('#pok_table_edit').DataTable()
                .cell(parent_jumlah_td)
                .data(formatUang(new_jumlah));
            //tampilan
            // setAutoNumeric(parent_jumlah_td, new_jumlah);

            var type = parent_jumlah_td.closest('tr').find('span').html();
            if(type != 'program'){
                updateParentJumlah(parent_jumlah_td, getNumber(old_jlh), getNumber(new_jumlah));
            }
        }

        function setAutoNumeric(element, number){
            element.autoNumeric('set', number);
        }

        function getNumber(obj){
            if(!obj || obj == '-' || obj == '') return 0;
            if (typeof obj === 'string' || obj instanceof String) return +obj.replace(/\D/g, '');
            return +obj;
        }

        //////////UNGGAH

        //submit unggah pok
        form_pok_unggah.on('submit', function(e) {
            e.preventDefault();
            if(!$('#thang').val().match(/^\d{4}$/)){
                generalAlert('Tahun tidak valid.');
                return;
            } else if(!$('#pok_name').val()){
                generalAlert('Nama POK tidak boleh kosong.');
                return;
            }
            $("#pok_unggah_button").prop("disabled",true);
            $("#pok_unggah_button").html('<i class="fa fa-spinner fa-pulse fa-1x fa-fw"></i> '+$("#pok_unggah_button").text());
            var formData = new FormData($(this)[0]);
            $('#pok_table_change').DataTable().clear().draw(false);

            $.ajax({
                url: location.protocol+'//'+window.location.host+'/pok/unggah_pok', 
                type: 'POST',
                data: formData,
                async: false,
                error: function(){
                    $("#pok_unggah_button").prop("disabled",false);
                    $("#pok_unggah_button").html('Unggah');
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });

        var nonames = {};
        socket.on('pok_unduh_finish', function(data) {
            $("#pok_unggah_button").prop("disabled",false);
            $("#pok_unggah_button").html('Unggah');

            nonames = data;
            $('#pok_unduh_rename').modal('show');
        })

        var prog_ht, keg_ht, akun_ht;
        $('#pok_unduh_rename').on('shown.bs.modal', function() {
            $('#prog_ht').html('');
            $('#keg_ht').html('');
            $('#akun_ht').html('');
            var container1 = document.getElementById('prog_ht');
            var container2 = document.getElementById('keg_ht');
            var container3 = document.getElementById('akun_ht');

            prog_ht = new Handsontable(container1, {
              data: nonames.progs,
              dataSchema: {kdprogram: null, uraian: null},
              rowHeaders: true,
              colHeaders: true,
              startCols: 0,
              minCols: 0,
              colWidths: [70, 300],
              manualColumnResize: true,
              minSpareRows: 0,
              colHeaders: ["Kode", "Uraian"],
              columns: [
                {data: 'kdprogram', readOnly: true},
                {data: 'uraian'}
              ]
            });
            keg_ht = new Handsontable(container2, {
              data: nonames.kegs,
              dataSchema: {kdgiat: null, uraian: null},
              rowHeaders: true,
              colHeaders: true,
              startCols: 0,
              minCols: 0,
              colWidths: [70, 300],
              manualColumnResize: true,
              minSpareRows: 0,
              colHeaders: ["Kode", "Uraian"],
              columns: [
                {data: 'kdgiat', readOnly: true},
                {data: 'uraian'}
              ]
            });
            akun_ht = new Handsontable(container3, {
              data: _.map(nonames.akuns, function(kdakun){ return {'kdakun': kdakun} }),
              dataSchema: {kdakun: null, uraian: null},
              rowHeaders: true,
              colHeaders: true,
              startCols: 0,
              minCols: 0,
              colWidths: [70, 300],
              manualColumnResize: true,
              minSpareRows: 0,
              colHeaders: ["Kode", "Uraian"],
              columns: [
                {data: 'kdakun', readOnly: true},
                {data: 'uraian'}
              ]
            });
        });

        $('#btn-simpan-uraian').click(function(){
            $("#btn-simpan-uraian").prop("disabled",true);
            $("#btn-simpan-uraian").html('<i class="fa fa-spinner fa-pulse fa-1x fa-fw"></i> '+$("#btn-simpan-uraian").text());
            var prog_ht_data = prog_ht.getSourceData();
            var keg_ht_data = keg_ht.getSourceData();
            var akun_ht_data = akun_ht.getSourceData();

            for (var i = prog_ht_data.length-1; i > -1; i--) {
                if(!prog_ht_data[i].uraian){
                    generalAlert('Program baris '+(i+1)+': blm terisi.')
                    $("#btn-simpan-uraian").html('Simpan');
                    $("#btn-simpan-uraian").prop("disabled",false);
                    return;
                }
                var data = {};
                data.type = 'program';
                data._id = prog_ht_data[i]._id;
                data.kdprogram = prog_ht_data[i].kdprogram;
                data.uraian = prog_ht_data[i].uraian
                socket.emit('pok_edit_item', data);
                prog_ht.alter('remove_row', i);
            }
            for (var i = keg_ht_data.length-1; i > -1; i--) {
                if(!keg_ht_data[i].uraian){
                    generalAlert('Kegiatan baris '+(i+1)+': blm terisi.')
                    $("#btn-simpan-uraian").html('Simpan');
                    $("#btn-simpan-uraian").prop("disabled",false);
                    return;
                }
                var data = {};
                data.type = 'kegiatan';
                data._id = keg_ht_data[i]._id
                data.kdgiat = keg_ht_data[i].kdgiat;
                data.uraian = keg_ht_data[i].uraian;
                socket.emit('pok_edit_item', data);
                keg_ht.alter('remove_row', i);
            }
            for (var i = akun_ht_data.length-1; i > -1; i--) {
                if(!akun_ht_data[i].uraian){
                    generalAlert('Akun baris '+(i+1)+': blm terisi.')
                    $("#btn-simpan-uraian").html('Simpan');
                    $("#btn-simpan-uraian").prop("disabled",false);
                    return;
                }
                socket.emit('pok_uraian_akun_entry', {'_id': akun_ht_data[i].kdakun, 'uraian': akun_ht_data[i].uraian});
                akun_ht.alter('remove_row', i);
            }
        })

        $('#pok_table_change').DataTable({
            columnDefs: [
                {
                    "targets": [ 0 ],
                    "visible": false,
                    "searchable": false
                }
            ],
            aaSorting: [],
            rowReorder: {
                enable: false
            },
            paging: false,
            createdRow: function( row, data, dataIndex ) {
                $( row ).find('td:eq(0)').attr('class', 'text-center');
                $( row ).find('td:eq(1)').attr('class', 'text-center');

                $( row ).find('td:eq(3)').attr('class', 'text-center');
                $( row ).find('td:eq(4)').attr('class', 'text-center');

                $( row ).find('td:eq(5)').attr('class', 'format-uang');
                $( row ).find('td:eq(6)').attr('class', 'format-uang');

                $( row ).find('td:eq(7)').attr('class', 'text-center');
            }
        });

        $('#tbl-lihat-akun').DataTable({
            columnDefs: [
                {
                    "targets": [ 0 ],
                    "visible": false,
                    "searchable": false
                }
            ],
            aaSorting: [],
            rowReorder: {
                enable: false
            },
            paging: false,
            createdRow: function( row, data, dataIndex ) {
                $( row ).find('td:eq(0)').attr('class', 'text-center');//status
                $( row ).find('td:eq(2)').attr('class', 'text-center');//vol

                $( row ).find('td:eq(3)').attr('class', 'text-center');//sat

                $( row ).find('td:eq(4)').attr('class', 'format-uang');//hrg sat
                $( row ).find('td:eq(5)').attr('class', 'format-uang');//jumlah
                $( row ).find('td:eq(6)').attr('class', 'text-center');//pilihan
            }
        });

        $('#pok_table_change').on('click', '.lihat-akun', function(){
            var selected_data = $('#pok_table_change').DataTable().row($(this).closest('tr')).data();
            socket.emit('lihat_akun_data', selected_data[0], function(details){
                $('#tbl-lihat-akun').DataTable().clear();
                _.each(details, function(detail, index, list){
                    var status = _.template('<span class="badge badge-<%= color %>"><%= status %></span>');
                    var changed_detail = $('#pok_table_change').DataTable()
                                .row( function ( idx, data, node ) {
                                    return data[0] == detail._id ?
                                        true : false;
                                } );

                    if(changed_detail[0].length){
                        status = changed_detail.data()[1]
                    } else {
                        status = status({color: 'default', status: 'tetap'})
                    }
                    $('#tbl-lihat-akun').DataTable().row.add( [
                            detail._id,
                            status,
                            detail.nmitem,
                            detail.volkeg,
                            detail.satkeg,
                            formatUang(detail.hargasat),
                            formatUang(detail.jumlah),
                            (changed_detail.data())?changed_detail.data()[8].replace(/\<button type\=\"button\" class=\"lihat\-akun\" title\=\"lihat semua detail dalam akun detail ini\"\>\<i class\=\"icon\-layers\"\>\<\/i\>\<\/button\>/g, ''):''
                        ] );
                });
                $('#tbl-lihat-akun').DataTable().draw(false);
            });
            $('#lihat-akun-modal-title').text(selected_data[2])
            $('#lihat-akun-modal').modal('show');
        })

        //kembalikan & buat baru
        $('#pok_table_change, #tbl-lihat-akun').on('click', '.kembalikan-buatbaru-detail', function(){
            var row = $(this).closest('tr');
            var table = $(this).closest('table');
            var selected_data = table.DataTable().row(row).data();
            socket.emit('kembalikan_buatbaru_detail', selected_data[0], function(back_data){
                if(back_data){
                    if(selected_data.length == 8){
                        table.DataTable().row(row).data([
                            back_data.prev_detail._id,
                            '<span class="badge badge-default">tetap</span>',
                            back_data.prev_detail.nmitem,
                            back_data.prev_detail.volkeg,
                            back_data.prev_detail.satkeg,
                            formatUang(back_data.prev_detail.hargasat),
                            formatUang(back_data.prev_detail.jumlah),
                            ''
                        ]);
                        $('#pok_table_change').DataTable().row(function ( idx, data, node ) {
                                    return data[0] == back_data.prev_detail._id ?
                                        true : false;
                                }).data([
                            back_data.prev_detail._id,
                            '<span class="badge badge-default">tetap</span>',
                            $('#lihat-akun-modal-title').text(),
                            back_data.prev_detail.nmitem,
                            back_data.prev_detail.volkeg,
                            back_data.prev_detail.satkeg,
                            formatUang(back_data.prev_detail.hargasat),
                            formatUang(back_data.prev_detail.jumlah),
                            '<button type="button" class="lihat-akun" title="lihat semua detail dalam akun detail ini"><i class="icon-layers"></i></button>'
                        ]);

                        table.DataTable().row.add( [
                            back_data.new_detail._id,
                            '<span class="badge badge-primary">baru</span>',
                            back_data.new_detail.nmitem,
                            back_data.new_detail.volkeg,
                            back_data.new_detail.satkeg,
                            formatUang(back_data.new_detail.hargasat),
                            formatUang(back_data.new_detail.jumlah),
                            '<button type="button" class="timpa-detail" title="timpa ke detail lain"><i class="icon-link"></i></button>'
                        ] ).draw(false);

                        $('#pok_table_change').DataTable().row.add( [
                            back_data.new_detail._id,
                            '<span class="badge badge-primary">baru</span>',
                            $('#lihat-akun-modal-title').text(),
                            back_data.new_detail.nmitem,
                            back_data.new_detail.volkeg,
                            back_data.new_detail.satkeg,
                            formatUang(back_data.new_detail.hargasat),
                            formatUang(back_data.new_detail.jumlah),
                            '<button type="button" class="timpa-detail" title="timpa ke detail lain"><i class="icon-link"></i></button> <button type="button" class="lihat-akun" title="lihat semua detail dalam akun detail ini"><i class="icon-layers"></i></button>'
                        ] ).draw(false);
                    } else {
                        table.DataTable().row(row).data([
                            back_data.prev_detail._id,
                            '<span class="badge badge-default">tetap</span>',
                            selected_data[2],
                            back_data.prev_detail.nmitem,
                            back_data.prev_detail.volkeg,
                            back_data.prev_detail.satkeg,
                            formatUang(back_data.prev_detail.hargasat),
                            formatUang(back_data.prev_detail.jumlah),
                            '<button type="button" class="lihat-akun" title="lihat semua detail dalam akun detail ini"><i class="icon-layers"></i></button>'
                        ]);

                        table.DataTable().row.add( [
                            back_data.new_detail._id,
                            '<span class="badge badge-primary">baru</span>',
                            selected_data[2],
                            back_data.new_detail.nmitem,
                            back_data.new_detail.volkeg,
                            back_data.new_detail.satkeg,
                            formatUang(back_data.new_detail.hargasat),
                            formatUang(back_data.new_detail.jumlah),
                            '<button type="button" class="timpa-detail" title="timpa ke detail lain"><i class="icon-link"></i></button> <button type="button" class="lihat-akun" title="lihat semua detail dalam akun detail ini"><i class="icon-layers"></i></button>'
                        ] ).draw(false);
                    }
                }
            })
        })
        //kembalikan (dari dihapus)
        $('#pok_table_change, #tbl-lihat-akun').on('click', '.kembalikan-detail', function(){
            var row = $(this).closest('tr');
            var table = $(this).closest('table');
            var selected_data = table.DataTable().row(row).data();
            socket.emit('kembalikan_detail', selected_data[0], function(detail){
                if(detail){
                    if(selected_data.length == 8){
                        table.DataTable().row(row).data([
                            detail._id,
                            '<span class="badge badge-default">tetap</span>',
                            detail.nmitem,
                            detail.volkeg,
                            detail.satkeg,
                            formatUang(detail.hargasat),
                            formatUang(detail.jumlah),
                            ''
                        ]);
                        $('#pok_table_change').DataTable().row(function ( idx, data, node ) {
                                    return data[0] == detail._id ?
                                        true : false;
                                }).data([
                            detail._id,
                            '<span class="badge badge-default">tetap</span>',
                            $('#lihat-akun-modal-title').text(),
                            detail.nmitem,
                            detail.volkeg,
                            detail.satkeg,
                            formatUang(detail.hargasat),
                            formatUang(detail.jumlah),
                            '<button type="button" class="lihat-akun" title="lihat semua detail dalam akun detail ini"><i class="icon-layers"></i></button>'
                        ]);
                    } else {
                        table.DataTable().row(row).data([
                            detail._id,
                            '<span class="badge badge-default">tetap</span>',
                            selected_data[2],
                            detail.nmitem,
                            detail.volkeg,
                            detail.satkeg,
                            formatUang(detail.hargasat),
                            formatUang(detail.jumlah),
                            '<button type="button" class="lihat-akun" title="lihat semua detail dalam akun detail ini"><i class="icon-layers"></i></button>'
                        ]);
                    }
                }
            })
        })
        //timpa
        var timpa_source_id;
        var timpa_row;
        var timpa_table;
        $('#pok_table_change, #tbl-lihat-akun').on('click', '.timpa-detail', function(){
            timpa_row = $(this).closest('tr');
            timpa_table = $(this).closest('table');
            var selected_data = timpa_table.DataTable().row(timpa_row).data();
            timpa_source_id = selected_data[0];

            (timpa_table.attr('id') == 'pok_table_change')?$('#timpa-lihat-akun-modal-title').text(selected_data[2]):$('#timpa-lihat-akun-modal-title').text($('#lihat-akun-modal-title').text());

            socket.emit('timpa_need_detail_list', selected_data[0], function(lists){
                var options ='<option>'
                        +   '--pilih--'
                        +'</option>';
                _.each(lists, function(item, index, list){
                    options +='<option value="'+item._id+'">'
                                +   item.noitem+' '+item.nmitem
                                + '</option>';
                })
                
                $('#timpa_d_blnj_list').empty().append(options);
            })
            
            $('#modal-timpa-detail').modal('show');
        })

        $('#btn-timpa').click(function(){
            if($('#timpa_d_blnj_list').val() == '--pilih--'){
                generalAlert('Harap pilih detail target.')
                return;
            }
            if($('#timpa_d_blnj_list').val() == timpa_source_id){
                generalAlert('Harap pilih detail yang berbeda.')
                return;
            }

            socket.emit('timpa_detail', {target_id: $('#timpa_d_blnj_list').val(), source_id: timpa_source_id}, function(source_detail){
                if(source_detail){
                    var selected_data = timpa_table.DataTable().row(timpa_row).data();
                    if(selected_data.length == 8){
                        selected_data[0] = $('#timpa_d_blnj_list').val();
                        selected_data[1] = '<span class="badge badge-success">update</span>'
                        selected_data[7] = '<button type="button" class="kembalikan-buatbaru-detail" title="kembalikan detail dan buat baru"><i class="icon-action-undo"></i></button>';
                        timpa_table.DataTable().row(function ( idx, data, node ) {
                                    return data[0] == $('#timpa_d_blnj_list').val() ?
                                        true : false;
                                }).remove().draw(false);
                        timpa_table.DataTable().row(timpa_row).data(selected_data);

                        $('#pok_table_change').DataTable().row(function ( idx, data, node ) {
                                    return data[0] == $('#timpa_d_blnj_list').val() ?
                                        true : false;
                                }).remove().draw(false);

                        $('#pok_table_change').DataTable().row(function ( idx, data, node ) {
                                    return data[0] == timpa_source_id ?
                                        true : false;
                                }).data([
                            $('#timpa_d_blnj_list').val(),
                            '<span class="badge badge-success">update</span>',
                            $('#lihat-akun-modal-title').text(),
                            source_detail.nmitem,
                            source_detail.volkeg,
                            source_detail.satkeg,
                            formatUang(source_detail.hargasat),
                            formatUang(source_detail.jumlah),
                            '<button type="button" class="kembalikan-buatbaru-detail" title="kembalikan detail dan buat baru"><i class="icon-action-undo"></i></button> <button type="button" class="lihat-akun" title="lihat semua detail dalam akun detail ini"><i class="icon-layers"></i></button>'
                        ]);
                    } else {
                        timpa_table.DataTable().row(function ( idx, data, node ) {
                                    return data[0] == $('#timpa_d_blnj_list').val() ?
                                        true : false;
                                }).remove().draw(false);
                        timpa_table.DataTable().row(timpa_row).data([
                            $('#timpa_d_blnj_list').val(),
                            '<span class="badge badge-success">update</span>',
                            selected_data[2],
                            source_detail.nmitem,
                            source_detail.volkeg,
                            source_detail.satkeg,
                            formatUang(source_detail.hargasat),
                            formatUang(source_detail.jumlah),
                            '<button type="button" class="kembalikan-buatbaru-detail" title="kembalikan detail dan buat baru"><i class="icon-action-undo"></i></button> <button type="button" class="lihat-akun" title="lihat semua detail dalam akun detail ini"><i class="icon-layers"></i></button>'
                        ]);
                    }
                }
                $('#modal-timpa-detail').modal('toggle');
            })
        })

        socket.on('pok_unduh_finish_xlsx', function(data) {
            $("#pok_unggah_button").prop("disabled",false);
            $("#pok_unggah_button").html('Unggah');
            generalAlert('POK telah diupdate.');
            $('#pok_table_change').DataTable().draw(false);
        })

        socket.on('pok_unduh_gagal_xlsx', function(data) {
            $("#pok_unggah_button").prop("disabled",false);
            $("#pok_unggah_button").html('Unggah');
            generalAlert('File tidak valid.');
        })

        socket.on('pok_unduh_finish_xlsx_add_change', function(data) {
            $('#pok_table_change').DataTable().row.add( data );
        });


        var detail_id_target_link;
        // $('#pok_table_change').on('click', '.link-realisasi', function(){
        //     detail_id_target_link = $('#pok_table_change').DataTable().row($(this).closest('tr')).data()[0];
        //     if(!$('#link_entry_detail').val()) socket.emit('pok_list', {'type': '', 'syarat': {}, 'sortby': 'kdprogram', 'for': 'riwayat'});
        //     $('#link_realisasi_modal').modal('show');
        // })
        //tambah list
        socket.on('pok_list_for_riwayat_for_link', function(data) {
            populateSelectForLink(data.items, data.type);
        })

        //fungsi umum tambah list
        var parent_code;
        function populateSelectForLink(lists, type){
            var options ='<option>'
                        +   '--pilih--'
                        +'</option>';
            
            _.each(lists, function(item, index, list){
                if(type == 'program'){
                    if(!parent_code){
                        options +='<option value="'+item._id+'">'
                                +   item.kdprogram+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else if(item.kdprogram !== parent_code){
                        options +='<option value="'+item._id+'">'
                                +   item.kdprogram+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.kdprogram+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    }                    
                } else if(type == 'kegiatan'){
                    if(!parent_code){
                        options +='<option value="'+item._id+'">'
                                +   item.kdgiat+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else if(item.kdgiat !== parent_code){
                        options +='<option value="'+item._id+'">'
                                +   item.kdgiat+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.kdgiat+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                        parent_code = item.kdprogram;
                    }                    
                } else if(type == 'output'){
                    if(!parent_code){
                        options +='<option value="'+item._id+'">'
                                +   item.kdoutput+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else if(item.kdoutput !== parent_code){
                        options +='<option value="'+item._id+'">'
                                +   item.kdoutput+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.kdoutput+' '+(item.uraian || '[uraian blm ada]')
                                + '</option>';
                        parent_code = item.kdgiat;
                    }                    
                } else if(type == 'soutput'){
                    if(!parent_code){
                        options +='<option value="'+item._id+'">'
                                +   item.kdsoutput+' '+item.ursoutput
                                + '</option>';
                    } else if(lists.length == 1 || item.kdsoutput == parent_code){
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.kdsoutput+' '+item.ursoutput
                                + '</option>';
                        parent_code = item.kdoutput;
                    } else {
                        options +='<option value="'+item._id+'">'
                                +   item.kdsoutput+' '+item.ursoutput
                                + '</option>';
                    }
                } else if(type == 'komponen'){
                    if(!parent_code){
                        options +='<option value="'+item._id+'">'
                                +   item.kdkmpnen+' '+item.urkmpnen
                                + '</option>';
                    } else if(item.kdkmpnen !== parent_code){
                        options +='<option value="'+item._id+'">'
                                +   item.kdkmpnen+' '+item.urkmpnen
                                + '</option>';
                    } else{
                        options +='<option value="'+item.kdkmpnen+'" selected="selected">'
                                +   item.kdkmpnen+' '+item.urkmpnen
                                + '</option>';
                        parent_code = item.kdsoutput;
                    }
                    
                } else if(type == 'skomponen'){
                    if(!parent_code){
                        options +='<option value="'+item._id+'">'
                            +   item.kdskmpnen+' '+item.urskmpnen
                            + '</option>';
                    } else if(lists.length == 1 || item.kdskmpnen == parent_code){
                        options +='<option value="'+item._id+'" selected="selected">'
                            +   item.kdskmpnen+' '+item.urskmpnen
                            + '</option>';
                        parent_code = item.kdkmpnen;
                    } else{
                        options +='<option value="'+item._id+'">'
                            +   item.kdskmpnen+' '+item.urskmpnen
                            + '</option>';
                    }
                } else if(type == 'akun'){
                    if(!parent_code){
                        options +='<option value="'+item._id+'">'
                            +   item.kdakun+' '+(item.uraian || '[uraian blm ada]')
                            + '</option>';
                    } else if(item.kdakun !== parent_code){
                        options +='<option value="'+item._id+'">'
                            +   item.kdakun+' '+(item.uraian || '[uraian blm ada]')
                            + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                            +   item.kdakun+' '+(item.uraian || '[uraian blm ada]')
                            + '</option>';
                        parent_code = item.kdskmpnen;
                    }
                } else if(type == 'detail'){
                    if(!detail_id_target_link){
                        options +='<option value="'+item._id+'">'
                                +   item.noitem+' '+item.nmitem
                                + '</option>';
                    } else if(item._id !== detail_id_target_link){
                        options +='<option value="'+item._id+'">'
                                +   item.noitem+' '+item.nmitem
                                + '</option>';
                    } else {
                        options +='<option value="'+item._id+'" selected="selected">'
                                +   item.noitem+' '+item.nmitem
                                + '</option>';
                        parent_code = item.kdakun;
                    }
                }
            })
            $('#link_entry_'+type).empty().append(options);
        }

        $('.pok-link-dropdown').change(function(){
            var type = $(this).attr('id').match(/link_entry_(.*)/)[1];

            var kode;
            if(!$("#link_entry_"+type+" option:selected").text().match(/\s?\w+(?=\s)/)) return;

            if(type != 'skomponen') kode = $("#link_entry_"+type+" option:selected").text().match(/\d+(?=\s)/)[0]
                else kode = $("#link_entry_"+type+" option:selected").text().match(/\s?\w+(?=\s)/)[0]

            var syarat = {};
            var sortby;

            if(type == 'program'){
                syarat.kdprogram = kode;
                sortby = 'kdgiat';
                $('#link_entry_kegiatan').empty();
                $('#link_entry_output').empty();
                $('#link_entry_soutput').empty();
                $('#link_entry_komponen').empty();
                $('#link_entry_skomponen').empty();
                $('#link_entry_akun').empty();
                $('#link_entry_detail').empty();
            } else if(type == 'kegiatan'){
                syarat.kdprogram = $("#link_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = kode;
                sortby = 'kdoutput';
                $('#link_entry_output').empty();
                $('#link_entry_soutput').empty();
                $('#link_entry_komponen').empty();
                $('#link_entry_skomponen').empty();
                $('#link_entry_akun').empty();
                $('#link_entry_detail').empty();
            } else if(type == 'output'){
                syarat.kdprogram = $("#link_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#link_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = kode;
                sortby = 'kdsoutput';
                $('#link_entry_soutput').empty();
                $('#link_entry_komponen').empty();
                $('#link_entry_skomponen').empty();
                $('#link_entry_akun').empty();
                $('#link_entry_detail').empty();
            } else if(type == 'soutput'){
                syarat.kdprogram = $("#link_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#link_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#link_entry_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = kode;
                sortby = 'kdkmpnen';
                $('#link_entry_komponen').empty();
                $('#link_entry_skomponen').empty();
                $('#link_entry_akun').empty();
                $('#link_entry_detail').empty();
            } else if(type == 'komponen'){
                syarat.kdprogram = $("#link_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#link_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#link_entry_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = $("#link_entry_soutput option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdkmpnen = kode;
                sortby = 'kdskmpnen';
                $('#link_entry_skomponen').empty();
                $('#link_entry_akun').empty();
                $('#link_entry_detail').empty();
            } else if(type == 'skomponen'){
                syarat.kdprogram = $("#link_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#link_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#link_entry_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = $("#link_entry_soutput option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdkmpnen = $("#link_entry_komponen option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdskmpnen = kode;
                sortby = 'kdakun';
                $('#link_entry_akun').empty();
                $('#link_entry_detail').empty();
            } else if(type == 'akun'){
                syarat.kdprogram = $("#link_entry_program option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdgiat = $("#link_entry_kegiatan option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdoutput = $("#link_entry_output option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdsoutput = $("#link_entry_soutput option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdkmpnen = $("#link_entry_komponen option:selected").text().match(/\d+(?=\s)/)[0];
                syarat.kdskmpnen = $("#link_entry_skomponen option:selected").text().match(/\s?\w+(?=\s)/)[0];
                syarat.kdakun = kode
                sortby = 'noitem'
                $('#link_entry_detail').empty();
            }

            socket.emit('pok_list', {'type': type, 'syarat': syarat, 'sortby': sortby, 'for': 'riwayat_for_link'});
        });

        ////////////////Object & Sockets

        //Server sockets response
        var opts = {
              lines: 13 // The number of lines to draw
            , length: 28 // The length of each line
            , width: 14 // The line thickness
            , radius: 42 // The radius of the inner circle
            , scale: 0.25 // Scales overall size of the spinner
            , corners: 1 // Corner roundness (0..1)
            , color: '#000' // #rgb or #rrggbb or array of colors
            , opacity: 0.25 // Opacity of the lines
            , rotate: 0 // The rotation offset
            , direction: 1 // 1: clockwise, -1: counterclockwise
            , speed: 1 // Rounds per second
            , trail: 60 // Afterglow percentage
            , fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
            , zIndex: 2e9 // The z-index (defaults to 2000000000)
            , className: 'spinner' // The CSS class to assign to the spinner
            , top: '50%' // Top position relative to parent
            , left: '50%' // Left position relative to parent
            , shadow: false // Whether to render a shadow
            , hwaccel: false // Whether to use hardware acceleration
            , position: 'absolute' // Element positioning
        }

        Highcharts.setOptions({
            global: {
                useUTC: false,
                
            },
            lang: {
              decimalPoint: '.',
              thousandsSep: ','
            }
        });

        function summaryUpdate(response){
            realisasi_bulan_lalu = response.sampai_bln_lalu;
            sampai_bln_ini = response.sampai_bln_ini;
            realisasi_bulan_ini = sampai_bln_ini - realisasi_bulan_lalu;
            pagu = response.pagu;
            sisa_dana = pagu - sampai_bln_ini;

            $('#s_realisasi-bulan-ini').html(formatUang(realisasi_bulan_ini).replace(/\-$/g,''));
            var bulan_ini_p = ((getNumber(realisasi_bulan_ini)/pagu)*100).toFixed(2)
            $('#s_realisasi-bulan-ini-percent').html(' ('+bulan_ini_p+'%)');
            // summaryChart.series[1].setData([+bulan_ini_p]);

            $('#s_realisasi-bulan-lalu').html(formatUang(realisasi_bulan_lalu).replace(/\-$/g,''));
            var bulan_lalu_p = ((getNumber(realisasi_bulan_lalu)/pagu)*100).toFixed(2)
            $('#s_realisasi-bulan-lalu-percent').html(' ('+bulan_lalu_p+'%)');
            // summaryChart.series[2].setData([+bulan_lalu_p]);

            $('#s_sampai-bln-ini').html(formatUang(sampai_bln_ini).replace(/\-$/g,''));
            $('#s_sampai-bln-ini-percent').html(' ('+((getNumber(sampai_bln_ini)/pagu)*100).toFixed(2)+'%)');

            $('#s_sisa-dana').html(formatUang(sisa_dana).replace(/\-$/g,''));
            var sisa_dana_p = ((getNumber(sisa_dana)/pagu)*100).toFixed(2);
            $('#s_sisa-dana-percent').html(' ('+sisa_dana_p+'%)');
            // summaryChart.series[0].setData([+sisa_dana_p]);

            var summaryChart = Highcharts.chart('container', {
                chart: {
                    type: 'column',
                    style: {
                        fontFamily: 'Helvetica'
                    }
                },
                title: {
                    text: 'Realisasi Anggaran',
                    style: {
                        fontSize: '1rem'
                    }
                },
                xAxis: {
                    type: 'Program',
                    categories: ['{{tahun_anggaran}}']
                },
                yAxis: {
                    title: {
                        text: 'Persentase (%)'
                    },
                    softMin: 0, max: 100,
                    tickInterval: 5

                },
                legend: {
                    enabled: true
                },
                credits: {
                    enabled: false
                },
                colors: [
                "#cfd8dc",
                "#90ed7d",
                "#7cb5ec"],
                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true,
                            format: '{point.y:.2f}%'
                        },
                        stacking: 'normal'
                    }
                },

                tooltip: {
                    headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                    pointFormat: '<span style="color:{point.color}"><b>{point.y:.2f}%</b> (Rp{point.jumlah:,.0f}) dari total anggaran<br/>'
                },

                exporting: {
                    chartOptions: {
                        plotOptions: {
                            series: {
                                dataLabels: {
                                    enabled: true
                                }
                            }
                        }
                    },
                    fallbackToExportServer: false
                },

                series: [{
                    name: 'Sisa Dana',
                    data: [{y: +sisa_dana_p, jumlah: sisa_dana}]
                }, {
                    name: 'Bulan Ini',
                    data: [{y: +bulan_ini_p, jumlah: realisasi_bulan_ini}]
                }, {
                    name: 'Sampai Bulan Lalu',
                    data: [{y: +bulan_lalu_p, jumlah: realisasi_bulan_lalu}]
                }]
            });

            var top_mines = Highcharts.chart('top_mines', {
                chart: {
                    type: 'column'
                },
                title: {
                    text: 'Sisa Dana Terendah',
                    style: {
                        fontSize: '1rem'
                    }
                },
                yAxis: {
                    softMin: 0,
                    title: {
                        text: 'Persentase (%)'
                    }
                    // ,
                    // stackLabels: {
                    //     enabled: true,
                    //     align: 'center'
                    // }
                },
                xAxis: {
                    categories: ['1', '2', '3', '4', '5']
                },
                credits: {
                    enabled: false
                },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{series.name}</span><table>',
                    pointFormat: '<tr><td style="padding:0">Sisa dana: <b>{point.y:,.2f}% (Rp{point.sisa_dana_rp:,.0f})</b></td></tr>',
                    footerFormat: '</table>',
                    useHTML: true
                },

                //to keep the itemWidth
                legend: {
                    enabled: true,
                    width:555,
                    itemWidth:500,
                    itemStyle: {
                        width:500
                    }
                },

                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true,
                            format: '{point.y:.2f}%'
                        },
                        stacking: 'normal'
                    }
                },
                series: [{
                    name: (response.top_mines[0])?response.top_mines[0].nmitem:'Blm ada item',
                    data: [{y: (response.top_mines[0])?+response.top_mines[0].sisa_dana.toFixed(2):0, 
                        sisa_dana_rp: (response.top_mines[0])?+response.top_mines[0].sisa_dana_rp:0}, null, null, null, null]

                }, {
                    name: (response.top_mines[1])?response.top_mines[1].nmitem:'Blm ada item',
                    data: [null, {y: (response.top_mines[1])?+response.top_mines[1].sisa_dana.toFixed(2):0, 
                        sisa_dana_rp: (response.top_mines[1])?+response.top_mines[1].sisa_dana_rp:0}, null, null, null]

                }, {
                    name: (response.top_mines[2])?response.top_mines[2].nmitem:'Blm ada item',
                    data: [null, null, {y: (response.top_mines[2])?+response.top_mines[2].sisa_dana.toFixed(2):0, 
                        sisa_dana_rp: (response.top_mines[2])?+response.top_mines[2].sisa_dana_rp:0}, null, null]

                }, {
                    name: (response.top_mines[3])?response.top_mines[3].nmitem:'Blm ada item',
                    data: [null, null, null, {y: (response.top_mines[3])?+response.top_mines[3].sisa_dana.toFixed(2):0, 
                        sisa_dana_rp: (response.top_mines[3])?+response.top_mines[3].sisa_dana_rp:0}, null]

                }, {
                    name: (response.top_mines[4])?response.top_mines[4].nmitem:'Blm ada item',
                    data: [null, null, null, null, {y: (response.top_mines[4])?+response.top_mines[4].sisa_dana.toFixed(2):0, 
                        sisa_dana_rp: (response.top_mines[4])?+response.top_mines[4].sisa_dana_rp:0}]

                }]
            });
        }

        socket.emit('pok_summary', new Date().getMonth(), function(response){
            summaryUpdate(response);
            Highcharts.setOptions({
                plotOptions: {
                    series: {
                        animation: false
                    }
                }
            });

            setInterval(
                function(){
                    socket.emit('pok_summary', new Date().getMonth(), function(response){
                        summaryUpdate(response);
                    });
                }
            ,10000);
        });

        $('#pok_entry_tab').one('click', function(e) {
            spinner.spin(target);
            socket.emit('pok_row_init', 'entry');
        })

        $('#pok_edit_tab').one('click', function(e) {
            spinner.spin(target2);
            socket.emit('pok_row_init', 'edit');
        })

        socket.on('pok_row_init_response', function(data, cb) {
            if(data.row == ''){
                cb();
                return;
            }
            // $("#pok_table tbody").append(data);
            $('#pok_table_'+data.tabel).DataTable().row.add( data.row );
            cb();
        })

        socket.on('pok_edit_update_jlh', function(data) {
            var prt_row = $('#pok_table_'+data.tabel).DataTable()
                                .rows( function ( idx, dataa, node ) {
                                    return dataa[0] == data.parent_id ?
                                        true : false;
                                } );
            //ambil parent td
            var parent_jumlah_td = prt_row
                                    .nodes()
                                    .to$()
                                    .find('td:eq(6)');

            if(parent_jumlah_td.length == 0) return;

            $('#pok_table_'+data.tabel).DataTable()
                .cell(parent_jumlah_td)
                .data(formatUang(data.new_jumlah));
        })

        socket.on('pok_item_deleted', function(id) {
            tabel_pok_edit_dt = $('#pok_table_edit').DataTable();
            var item_row = $('#pok_table_edit').DataTable()
                                .rows( function ( idx, data, node ) {
                                    return data[0] ==id ?
                                        true : false;
                                    });

            updateParentJumlah(item_row.nodes().to$().find('td:eq(6)'), getNumber(item_row.nodes().to$().find('td:eq(6)').text()), 0);
            var type = item_row.nodes().to$().find('td:eq(0)').text();
            if(type == 'detail') item_row.remove().draw(false)
                else {
                    removeChilds($('#pok_table_edit').DataTable().row(item_row.nodes().to$()), 'remove');
                    item_row.remove().draw(false);
                }
            generalAlert('Satu item '+type+' telah dihapus.');
        })

        socket.on('pok_datatable_apply', function(tabel) {
            if(tabel == 'edit') $('#pok_table_edit').DataTable().draw(false);
            //update jumlah
            else {
                $('#pok_table_entry').DataTable().draw(false);
                var prt_row = $('#pok_table_entry').DataTable()
                        .rows( function ( idx, data, node ) {
                            return data[2] == '<span class="badge badge-default">program</span>' ?
                                true : false;
                        } );

                var sampai_bln_ini = 0;
                var sisa_dana = 0;

                var pagu = 0;

                _.each(prt_row.data(), function(program, index, list){
                    sampai_bln_ini += getNumber(program[11]);
                    sisa_dana += getNumber(program[13]);

                    pagu += getNumber(program[8]);
                })

                if(sisa_dana == 0){
                    $('#sisa-dana').html(formatUang(pagu).replace(/\-$/g,''));
                    if(!pagu) $('#sisa-dana-percent').html(' (0%)');
                        else $('#sisa-dana-percent').html(' ('+((getNumber(pagu)/pagu)*100).toFixed(0)+'%)');
                }                
            }
            spinner.stop();
            //format uang
            $('td.format-uang').each (function() {
                $(this).text(formatUang($(this).text()));
            });
            adjustColumn()
        })

        socket.on('title_change', function(new_pok_name) {
            $('.pok-title').text(new_pok_name);
            $('#pok_title').val(new_pok_name);
        })

        socket.on('pok_new_entry', function(new_pok_item) {
            var cell0 = new_pok_item._id;
            var cell1 = new_pok_item.parent_id;
            var badge = _.template('<span class="badge badge-<%= color %>"><%= item %></span>')
            var cell2 = '';
            var cell3 = '';
            var cell4 = '';
            var cell5 = '';
            var cell6 = '';
            var cell7 = '';
            var cell8 = '';
            var cell9 = '';

            if(new_pok_item.type == 'detail'){
                cell2 = badge({color: 'success', item: 'detail'})
                cell4 = new_pok_item.nmitem
                cell5 = new_pok_item.volkeg
                cell6 = new_pok_item.satkeg
                cell7 = new_pok_item.hargasat
                cell8 = new_pok_item.jumlah
                cell9 = '<button type="button" class="hapus-item"><i class="icon-close"></i></button>'
            } else if(new_pok_item.type == 'program'){
                cell2 = badge({color: 'default', item: 'program'})
                cell3 = '054.01.'+new_pok_item.kdprogram
                cell4 = new_pok_item.uraian
                cell9 = '<button type="button" class="tambah"><i class="icon-plus"></i></button> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
            } else if(new_pok_item.type == 'kegiatan'){
                cell2 = badge({color: 'default', item: 'kegiatan'})
                cell3 = new_pok_item.kdgiat
                cell4 = new_pok_item.uraian
                cell9 = '<button type="button" class="tambah"><i class="icon-plus"></i></button> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
            } else if(new_pok_item.type == 'output'){
                cell2 = badge({color: 'danger', item: 'output'})
                cell3 = new_pok_item.kdgiat+'.'+new_pok_item.kdoutput
                cell4 = new_pok_item.uraian
                cell9 = '<span class="dropdown"><button class="dropdown-toggle" type="button" data-toggle="dropdown"><i class="icon-plus"></i><span class="caret"></span></button><ul class="dropdown-menu"><li><a subitem="soutput" class="tambah" href="#">Sub Output</a></li><li><a subitem="komponen" class="tambah" href="#">Komponen</a></li></ul></span> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
            } else if(new_pok_item.type == 'soutput'){
                cell2 = badge({color: 'danger', item: 'soutput'})
                cell3 = new_pok_item.kdoutput+'.'+new_pok_item.kdsoutput
                cell4 = new_pok_item.ursoutput
                cell9 = '<button type="button" class="tambah"><i class="icon-plus"></i></button> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
            } else if(new_pok_item.type == 'komponen'){
                cell2 = badge({color: 'primary', item: 'komponen'})
                cell3 = new_pok_item.kdkmpnen
                cell4 = new_pok_item.urkmpnen
                cell9 = '<span class="dropdown"><button class="dropdown-toggle" type="button" data-toggle="dropdown"><i class="icon-plus"></i><span class="caret"></span></button><ul class="dropdown-menu"><li><a subitem="skomponen" class="tambah" href="#">Sub Komponen</a></li><li><a subitem="akun" class="tambah" href="#">Akun</a></li></ul></span> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
            } else if(new_pok_item.type == 'skomponen'){
                cell2 = badge({color: 'primary', item: 'skomponen'})
                cell3 = new_pok_item.kdskmpnen
                cell4 = new_pok_item.urskmpnen
                cell9 = '<button type="button" class="tambah"><i class="icon-plus"></i></button> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
            }  else if(new_pok_item.type == 'akun'){
                cell2 = badge({color: 'warning', item: 'akun'})
                cell3 = new_pok_item.kdakun
                cell4 = new_pok_item.uraian
                cell9 = '<button type="button" class="tambah"><i class="icon-plus"></i></button> <button type="button" class="hapus-item"><i class="icon-close"></i></button>'
            }

            var parent_row = $('#pok_table_edit').DataTable()
                        .rows( function ( idx, data, node ) {
                            return data[1] == new_pok_item.parent_id ?
                                true : false;
                        } )
                        .nodes()
                        .to$();

            var table = $('#pok_table_edit').DataTable();
        
            //insert a test row
            table.row.add([cell0, cell1, cell2, cell3, cell4, cell5, cell6, cell7, cell8, cell9]);
            //move added row to desired index (here the row we clicked on)
            var index = table.row(parent_row).index();
            if(new_pok_item.type == 'program') index = 0;
            var rowCount = table.data().length-1,
                insertedRow = table.row(rowCount).data(),
                tempRow;

            for (var i=rowCount;i>index;i--) {
                tempRow = table.row(i-1).data();
                table.row(i).data(tempRow);
                table.row(i-1).data(insertedRow);
            }     
            //refresh the page
            $('#pok_table_edit').DataTable().draw(false);
            if(new_pok_item.type == 'detail') updateParentJumlah(parent_row.find('td:eq(6)'), 0, getNumber(cell8));
            generalAlert('Baru: '+'1 ['+new_pok_item.type+'] ditambahkan.');
        })

        socket.on('pok_item_change', function(item) {
            var row_affected = $('#pok_table_edit').DataTable()
                                .rows( function ( idx, data, node ) {
                                    return data[0] ==item._id ?
                                        true : false;
                                } );
            var type = row_affected
                            .nodes()
                            .to$()
                            .find('span')
                            .html();

            delete item._id;
            _.each(_.keys(item), function(element, index, list){
                if(type == 'detail'){
                    if(element == 'nmitem'){
                        updateCell(row_affected, 2, item[element], false)
                    } else if(element == 'volkeg'){
                        updateCell(row_affected, 3, item[element], true)
                        var tr = row_affected.nodes().to$();
                        setNumberMultiply(tr.find('td:eq(6)'), tr.find('td:eq(3)'), tr.find('td:eq(5)'))
                    } else if(element == 'hargasat'){
                        updateCell(row_affected, 5, item[element], true)
                        var tr = row_affected.nodes().to$();
                        setNumberMultiply(tr.find('td:eq(6)'), tr.find('td:eq(5)'), tr.find('td:eq(3)'))
                    } else if(element == 'jumlah'){
                        updateCell(row_affected, 6, item[element], true)
                    } else if(element == 'satkeg'){
                        updateCell(row_affected, 4, item[element], false)
                    }
                    
                } else if(type == 'akun'){
                    if(element == 'uraian'){
                        updateCell(row_affected, 2, item[element], false)
                    } else if(element == 'kdakun'){
                        updateCell(row_affected, 1, item[element], false)
                    }
                } else if(type == 'skomponen'){
                    if(element == 'urskmpnen'){
                        updateCell(row_affected, 2, item[element], false)
                    } else if(element == 'kdskmpnen'){
                        updateCell(row_affected, 1, item[element], false)
                    }
                } else if(type == 'komponen'){
                    if(element == 'urkmpnen'){
                        updateCell(row_affected, 2, item[element], false)
                    } else if(element == 'kdkmpnen'){
                        updateCell(row_affected, 1, item[element], false)
                    }
                } else if(type == 'soutput'){
                    if(element == 'ursoutput'){
                        updateCell(row_affected, 2, item[element], false)
                    } else if(element == 'kdskmpnen'){
                        updateCell(row_affected, 1, item[element], false)
                    }
                } else if(type == 'output'){
                    if(element == 'uraian'){
                        updateCell(row_affected, 2, item[element], false)
                    } else if(element == 'kdoutput'){
                        updateCell(row_affected, 1, item[element], false)
                    }
                } else if(type == 'kegiatan'){
                    if(element == 'uraian'){
                        updateCell(row_affected, 2, item[element], false)
                    } else if(element == 'kdgiat'){
                        updateCell(row_affected, 1, item[element], false)
                    }
                } else if(type == 'program'){
                    if(element == 'uraian'){
                        updateCell(row_affected, 2, item[element], false)
                    } else if(element == 'kdprogram'){
                        item[element] = '054.01.'+item[element];
                        updateCell(row_affected, 1, item[element], false)
                    }
                }
                generalAlert('Baru: '+'['+type+'] '+item[element]);
            })    
        });

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            adjustColumn();
        });


        function updateCell(row, index, new_value, format_uang){
            var target_td = row
                            .nodes()
                            .to$()
                            .find('td:eq('+index+')');

            $('#pok_table_edit').DataTable()
                .cell(target_td)
                .data(new_value)
                .draw(false);
            // if(format_uang) setAutoNumeric(target_td, new_value);
            if(format_uang) target_td.text(formatUang(new_value))
        }

        //Fungsi umum
        function getAjax(url, handleData) {
          $.ajax({
            url:url,  
            success:function(data) {
              handleData(data); 
            }
          });
        }

        function formatUang(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function generalAlert(message){
            $.toast({
                text: message,
                textAlign: 'left', 
                hideAfter: 4000,
                loader: false,
                position: 'bottom-right',
                stack: 2
            })
        }

        function generalAlertNoTimeout(message){
            $.toast({
                text: message,
                textAlign: 'left',
                hideAfter: false,
                loader: false,
                position: 'bottom-right'
            })
        }

        socket.on('messagesNoTimeout', function(data) {
            generalAlertNoTimeout(data)
        });
    });
</script>